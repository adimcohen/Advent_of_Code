drop table if exists AOC_2024_Day06_Map
drop table if exists AOC_2024_Day06_Rel
drop table if exists AOC_2024_Day06_AltRel

create table AOC_2024_Day06_Map(ID int,
								X int,
								Y int,
								Symbol char(1)
								)

create table AOC_2024_Day06_Rel(FromID int,
								ToID int,
								Rt varchar(max),
								Symbol char(1),
								Dir char(1)
								)

create table AOC_2024_Day06_AltRel(FromID int,
									ToID int,
									ObsID int,
									Dir char(1)
									)
GO
create or alter function fn_AOC_2024_Day06_CheckLoop(@ObsID int) returns table
as
return with rec as
			(select ID, X, Y, cast(concat(',', ID, '.', '^', '.', X, '/', Y, ',') as varchar(max)) Rt, '^' Dir, 0 Steps, 0 IsLoop
					, 0 src
				from AOC_2024_Day06_Map
				where Symbol = '^'
				union all
				select n.ToID, m.X, m.Y, cast(concat(r.Rt, n1.Rt, ',') as varchar(max)) Rt, n.Dir, r.Steps + 1 Steps, n2.IsLoop
					, case when l.ToID is not null then 2
							when l1.ToID is not null then 3
						end src
				from rec r
					outer apply (select *
									from AOC_2024_Day06_Rel l
									where l.FromID = r.ID
										and l.Dir = r.Dir
								) l
					outer apply (select *
									from AOC_2024_Day06_AltRel l1
									where l1.FromID = r.ID
										and l1.Dir = r.Dir
										and l1.ObsID = @ObsID
								) l1
					cross apply (select coalesce(l1.ToID, l.ToID) ToID
										, case r.Dir
												when '^' then '>'
												when '>' then 'v'
												when 'v' then '<'
												when '<' then '^'
											end Dir
								) n
					inner join AOC_2024_Day06_Map m on m.ID = n.ToID
					cross apply (select concat(n.ToID, '.', n.Dir, '.', m.X, '/', m.Y) Rt) n1
					cross apply (select iif(r.Rt like concat('%', n1.Rt, ',%'), 1, 0) IsLoop) n2
				where r.IsLoop = 0
					and m.Symbol in ('.', '^')
			)
		select top 1 cast(IsLoop as bit) IsLoop
		from rec
		order by Steps desc
GO
declare @Input varchar(max) =
'........#........................................#......#........#................................................................
....................................#......#.....#............#.............#..........#..........................................
......................#.......................................................#...................................................
.......#..#..#....#...#...#....#..............#......#.......#...#................#.......#.......................................
......................#....##...#.......#....#.......................................#....................#.......................
...#............................#........................................#..........................#.....................#.......
....................#............#...............#......#.........#...........#...................................................
............................#......#...#................#.............#...........................................................
.....#..#.........#....................#......................................................#........................#.........#
.........#..##.#.........#.............................................#...........#........#....................##...............
...............#....#.........................##......#.....................#..............................................#......
..................##...................................#...........#........#....#.............#..................#........#.#....
....................................#...................#..............................#............#.............................
.........#.....#................#..........................................#...................................#..............#...
...#....................#...................................#..##...................#.......#......................###.........#..
....................#............#....#.##....#.........#......#...#........................#.......................#..........#..
..............#...................................................................................#....................#..........
.........#................#..............................#............................#...#.................#...............#.....
............................................................................................#...#............................#....
............#....................#................................#....#...............................#....#.....................
........................................#.........#..................................................#..#..................#......
.............#.#............................#..#.....#............................................#....#..........................
................................................................................................#.........#..#..............#..#..
...........#..........#.#..#................#.#..#...#.........#..........................................#..........#..#.........
.............................#....................#.......#....#.....#....#......#....................#..#...............##.......
..........#..............................................................................#....#.........#..#................#.....
..#..#...............................................................#.......#........#...........................#...............
...........................................................................#...##....................#.#....##....................
.......................................#...............................................#.....................#.........#..........
.......................................................#.......#....#................#.....................................#......
.............#................#...................#.................#....................#..................#.#.........#.........
.....................................................................#.....................................#......................
........................#..........................................#....#..#.#..........................................#.........
............#.......#..................#.................................................#..............#.......................#.
.........................................................#...............#...#....#...........#.................................#.
.........................#..........................#..#........................................................#.................
...............#....................................#.......#......................................#............#.................
.#......................................................................................................#.........................
#...#........................................................#.................#....#....................#...........#............
..#.........#................................................................#................................#.............#.....
..................................#.........................................................................#................#....
..............#..............................................#........#..................................#........................
......#............................................#.................................#............................#...............
.......##..#.......................##............#...#...................#.#..........................................##..........
.#......#.....................................................................#..#..........................#......#.............#
.................#.....................#........##..#.........#........#................#.........................................
...........#.....#..........#........#............................................................................................
.........................#......#.......................................#..............................#..........................
............#............................................................#..............#..............................#..........
..................#.........#...........................................................................................#.........
#.#..................................#....................#......................#.............#.................................#
....#................#.................#...................#...........#......................................#...................
................#........................................................................................#....#.#.......#.....##..
..........#...#.......................................#........#.......................................#...#......................
.......#..##........................#......##.........................#.........#.......#.............................#.....#.....
................#...............................................#....#..........#.....#.........#.........#.........#.............
...............................#............#....................................#......#......................................#..
.#..#..................#............................................#....#............#...............##...#..........#...........
....#.............................................................................................................................
.............................................................#...........................#..........#.............................
.#........#..................#.....#.............#.....................................................#...#........#...........#.
.......................#........................................#.....#............................#.#..................#.........
................#....#................#.......#............................#.......#.................#............................
....#.........#....#........#.....................#........................#............#.........................................
.......#.......#.....................................................................##...........#...............................
...........#.........................................................#..........#............#....................................
..................#.............................#.......................................................................#.........
................#.....#........#.....#...#..........#.....................................#.....#........................#........
..........................................#.........#...........#.................................................................
...#.......................................................................................................#......................
....#..............#...........#..................................................#.................#.................#...........
.#................#.....#.#.................................................................#.........................#...........
............#.........................##....................................#..............#......................................
...##...........#...#............#..........................................................................#.....................
............................................#......................#......#.......................................................
............#............................................................................................................#........
...................##..............#.#....#.##...................................................#..................#.............
..#...................................................................................#.........#.........................#.....#.
........................#..............................................#......#................................................#..
................#............#............................#.#...................#.....................#...........................
..................#......#................#.#......................#...................#...#......................................
..#................................................##...................................................................#.........
...........................#......................................................................#......#...#......#.............
........................#...#........#......#.......#..........#.............................#........#.....#.....................
.................................................#..............................................#......#.....#....................
.....#....#.................#......#........#.#..............^...........................#...................#..#.................
.............................................................................#................................#...................
#..........................#..#..............#.......#..........................#.................................................
............#.............................................................................#...................#...................
..................#.............................#.........................................#................#.........#......#.....
...#...............................#.....#......#............###.#.#.....................................#....#.............#.....
...........#...........#...........................#..............................................................................
............#..........................................#.....#.............#..........................#....................#.....#
........................#......#..#............................#.......................................................#..........
..#...#...#.......#.#..........................................#.............#.........#....#..................#...........#......
..................#.......#.....................................................................................#........#........
......##................#...........................................#..............##.................................#...........
.................#................................................................................#.#....................#........
....................#.........#..........#...............#...#...#.#.#............................................................
#..................#.#..........#..#...................................................................................#..........
..........#........................................................#..........##..........................#..##...................
...........#...................................................................#..................................................
..................#........#............................................#..................#....#.......................#..#......
............#...................#......#..........................................................................................
...........................#.....##..........#.#..............#......................#.............#.......#...........#..........
............#..................................................#.......#.........#.#..................#..............##...........
#..................................................#...#......#..#......................#.............#........#............#.....
....#..................#..........#.........#.........................................#..................#................#.......
...#.................#.............................................................................#....................#.........
..........#.................................................................#............#....................#.#.#.....#.........
.....................#......................#...........#........#................................................................
.....#.......................................................................#......................#...#......#..................
.............##........#.....................#...........##........#............#.....#.....................#...............#.....
.....#.........#....#.................#....#...........#.......##..........#.........#.#......................................#...
.......#..................##.......#...#.#...#...................................#.......................................#.....#..
...............#.......#.................#........................................................................................
......#.......#.....#...............................#...........#.......#......................##...#....#........................
.##..........................##..................##................#..#....#...##.................................................
........#..............................#.#......#........#...............#....#........#.#........................................
...............................#..#.....................#.#...................#...................................................
.....................#.................................................##...#.......#.................##...............#.......#..
.............#..........................#.................................#..............#.......#..........#........#............
.........................................#...................#.........................................................#..........
...............................#..........#..............................#............#.....#.....................................
.............#..........................#....................#................................#...#............#..................
....#......#........#.......#......#................................................#...#......................................##.
..#...................................#........#.....................................#...#......#.........#..#..........#.........
.......#.........#................................................................................................................
...........#...............................##.........................................#..#....................#.....#.#.......##..
.........................#..#...............#............................#.............#..........................#..............#'

drop table if exists #Route
drop table if exists #Obstacles

;with i as
	(select c.[value] X, r.ordinal Y, substring(r.[value], c.[value], 1) Symbol, len(r.[value]) MaxX, count(*) over(partition by r.ordinal) MaxY
		from string_split(replace(@Input, char(10), ''), char(13), 1) r
			cross apply generate_series(cast(1 as int), cast(len(r.[value]) as int)) c
	)
	, Maxes as
	(select top 1 MaxX, MaxY
		from i
	)
	, i1 as
	(
	select X, Y, Symbol
		from i
		union
		select [value] X, Y, '' Symbol
		from Maxes
			cross apply generate_series(cast(1 as int), cast(MaxX as int))
			cross apply (values(0)
							, (MaxY + 1)
						) v(Y)
		union
		select X, [value] Y, '' Symbol
		from Maxes
			cross apply generate_series(cast(1 as int), cast(MaxY as int))
			cross apply (values(0)
							, (MaxX + 1)
						) v(X)
	)
insert into AOC_2024_Day06_Map
select row_number() over(order by Y, X) ID, *
from i1

create unique clustered index IX_AOC_2024_Day06_Map on AOC_2024_Day06_Map(ID)
create unique index IX_AOC_2024_Day06_Map_1 on AOC_2024_Day06_Map(X, Y) include(Symbol)

insert into AOC_2024_Day06_Rel
select m.ID fID, l1.ID tID, Rt, l.Symbol, '>' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X - 1 X, o.Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y = m.Y
						and o.X > m.X
					order by o.X
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat([value], '.', m.Y) p, '>' d
							from generate_series(m.X, l.X)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol  = '#'
					and o.X = m.X
						and o.Y = m.Y - 1
					)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, '<' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X + 1 X, o.Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y = m.Y
						and o.X < m.X
					order by o.X desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat([value], '.', m.Y) p, '<' d
							from generate_series(l.X, m.X)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X
						and o.Y = m.Y + 1
					)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, 'v' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y - 1 Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y > m.Y
						and o.X = m.X
					order by o.Y
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, 'v' d
							from generate_series(m.Y, l.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X + 1
						and o.Y = m.Y
					)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, '^' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y + 1 Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y < m.Y
						and o.X = m.X
					order by o.Y desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, '^' d
							from generate_series(l.Y, m.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X - 1
						and o.Y = m.Y
					)
	and not (m.X = l.X and m.Y = l.Y)
union all
select m.ID FromID, l1.ID ToID, Rt, m.Symbol, '^'
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y + 1 Y, o.Symbol
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y < m.Y
						and o.X = m.X
					order by o.Y desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, '^' d
							from generate_series(l.Y, m.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol = '^'

;with sp as
	(select r.FromID, r.ToID, m.X, m.Y, r.Rt, m1.Symbol
		from AOC_2024_Day06_Rel r
			inner join AOC_2024_Day06_Map m on m.ID = r.ToID
			inner join AOC_2024_Day06_Map m1 on m1.X = m.X
											and m1.Y = m.Y - 1
		where r.Symbol = '^'
	)
	, rec as
	(select FromID, ToID, X, Y, RT, cast(RT as varchar(max)) PartialRt, Symbol, 1 Steps
		from sp
		union all
		select r.ToID, l.ToID, m.X, m.Y, r.RT + ',' + l.Rt, l.Rt PartialRt, l.Symbol, r.Steps + 1 Steps
		from rec r
			inner join AOC_2024_Day06_Rel l on l.FromID = r.ToID
			inner join AOC_2024_Day06_Map m on m.ID = l.ToID
		where r.Symbol != ''
	)
select *
into #Route
from rec
order by Steps desc
option (maxrecursion 32767)

;with r as
	(select top 1 Rt
		from #Route
		order by Steps desc
	)
select count(distinct json_value([value], '$.p')) Answer1
from #Route
	cross apply openjson('[' + Rt + ']')

;with i as
	(select distinct FromID, ToID, json_value([value], '$.p') p, json_value([value], '$.d') d
		from #Route
			cross apply openjson('[' + PartialRt + ']')
	)
	, i1 as
	(select FromID, NewTo.ID ToID, NewObs.ID ObsID, d Dir
		from i
			cross apply (select cast(parsename(p, 2) as int) X, cast(parsename(p, 1) as int) Y) i1
			inner join AOC_2024_Day06_Map NewObs on NewObs.X = i1.X
												and NewObs.Y = i1.Y
			cross apply (select NewObs.X + case d
												when '>' then -1
												when '<' then 1
												else 0
											end X,
								NewObs.Y + case d
													when 'v' then -1
													when '^' then 1
													else 0
												end Y
						) i2
			inner join AOC_2024_Day06_Map NewTo on NewTo.X = i2.X
													and NewTo.Y = i2.Y
			inner join AOC_2024_Day06_Map OrigFrom on OrigFrom.ID = i.FromID
		where NewObs.Symbol = '.'
			and NewTo.Symbol not in ('#', '')
			and NewTo.ID != i.FromID
			and not (d = '>' and NewTo.X < OrigFrom.X)
			and not (d = '<' and NewTo.X > OrigFrom.X)
			and not (d = '^' and NewTo.Y > OrigFrom.Y)
			and not (d = 'v' and NewTo.Y < OrigFrom.Y)
	)
	, NewObs as
		(select distinct NewObs.X, NewObs.Y, NewObs.ID
			from i
				cross apply (select cast(parsename(p, 2) as int) X, cast(parsename(p, 1) as int) Y) i1
				inner join AOC_2024_Day06_Map NewObs on NewObs.X = i1.X
															and NewObs.Y = i1.Y
			where NewObs.Symbol = '.'
		)
insert into AOC_2024_Day06_AltRel
select FromID, ToID, ObsID, Dir
from i1
union all
select NewFrom.ID FromID, NewTo.ID ToID, NewObs.ID ObsID, Dir
from NewObs
	cross apply (select NewObs.X + 1 X, NewObs.Y, '^' Dir) n
	inner join AOC_2024_Day06_Map NewFrom on NewFrom.X = n.X
										and NewFrom.Y = n.Y
	cross apply (select top 1 m1.X, m1.Y + 1 Y
					from AOC_2024_Day06_Map m1
					where m1.X = n.X
						and m1.Y < n.Y
						and m1.Symbol in ('#', '')
					order by m1.Y desc
				) m
	inner join AOC_2024_Day06_Map NewTo on NewTo.X = m.X
										and NewTo.Y  = m.Y
where NewTo.Symbol not in ('#', '')
union all
select NewFrom.ID FromID, NewTo.ID ToID, NewObs.ID ObsID, Dir
from NewObs
	cross apply (select NewObs.X - 1 X, NewObs.Y, 'v' Dir) n
	left join AOC_2024_Day06_Map NewFrom on NewFrom.X = n.X
										and NewFrom.Y = n.Y
	cross apply (select top 1 m1.X, m1.Y - 1 Y
					from AOC_2024_Day06_Map m1
					where m1.X = n.X
						and m1.Y > n.Y
						and m1.Symbol in ('#', '')
					order by m1.Y
				) m
	left join AOC_2024_Day06_Map NewTo on NewTo.X = m.X
										and NewTo.Y  = m.Y
where NewTo.Symbol not in ('#', '')
union all
select NewFrom.ID FromID, NewTo.ID ToID, NewObs.ID ObsID, Dir
from NewObs
	cross apply (select NewObs.X X, NewObs.Y + 1 Y, '>' Dir) n
	inner join AOC_2024_Day06_Map NewFrom on NewFrom.X = n.X
										and NewFrom.Y = n.Y
	cross apply (select top 1 m1.X - 1 X, m1.Y
					from AOC_2024_Day06_Map m1
					where m1.X > n.X
						and m1.Y = n.Y
						and m1.Symbol in ('#', '')
					order by m1.X
				) m
	inner join AOC_2024_Day06_Map NewTo on NewTo.X = m.X
										and NewTo.Y  = m.Y
where NewTo.Symbol not in ('#', '')
union all
select NewFrom.ID FromID, NewTo.ID ToID, NewObs.ID ObsID, Dir
from NewObs
	cross apply (select NewObs.X X, NewObs.Y - 1 Y, '<' Dir) n
	inner join AOC_2024_Day06_Map NewFrom on NewFrom.X = n.X
										and NewFrom.Y = n.Y
	cross apply (select top 1 m1.X + 1 X, m1.Y
					from AOC_2024_Day06_Map m1
					where m1.X < n.X
						and m1.Y = n.Y
						and m1.Symbol in ('#', '')
					order by m1.X desc
				) m
	inner join AOC_2024_Day06_Map NewTo on NewTo.X = m.X
										and NewTo.Y  = m.Y
where NewTo.Symbol not in ('#', '')

;with obs as
	(select distinct ObsID
		from AOC_2024_Day06_AltRel
	)
select ObsID, row_number() over(order by ObsID) ID
into #Obstacles
from obs

select *
from AOC_2024_Day06_Map
where Symbol = '^'

;with rec as
	(select 0 ID, cast(0 as bit) IsLoop
		union all
		select n.ID, l.IsLoop
		from rec
			cross apply (select ID + 1 ID) n
			inner join #Obstacles o on o.ID = n.ID
			cross apply fn_AOC_2024_Day06_CheckLoop(o.ObsID) l
	)
--select sum(cast(IsLoop as int)) Answer2
select *
--into ##My
from rec r
	inner join #Obstacles o on o.ID = r.ID
	inner join AOC_2024_Day06_Map m on m.ID = o.ObsID
where IsLoop = 1
option (maxrecursion 32767)