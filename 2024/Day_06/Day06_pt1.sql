drop table if exists AOC_2024_Day06_Map
drop table if exists AOC_2024_Day06_Rel

create table AOC_2024_Day06_Map(ID int,
								X int,
								Y int,
								Symbol char(1)
								)

create table AOC_2024_Day06_Rel(FromID int,
								ToID int,
								Rt varchar(max),
								Symbol char(1),
								Dir char(1)
								)
declare @Input varchar(max) =
'........#........................................#......#........#................................................................
....................................#......#.....#............#.............#..........#..........................................
......................#.......................................................#...................................................
.......#..#..#....#...#...#....#..............#......#.......#...#................#.......#.......................................
......................#....##...#.......#....#.......................................#....................#.......................
...#............................#........................................#..........................#.....................#.......
....................#............#...............#......#.........#...........#...................................................
............................#......#...#................#.............#...........................................................
.....#..#.........#....................#......................................................#........................#.........#
.........#..##.#.........#.............................................#...........#........#....................##...............
...............#....#.........................##......#.....................#..............................................#......
..................##...................................#...........#........#....#.............#..................#........#.#....
....................................#...................#..............................#............#.............................
.........#.....#................#..........................................#...................................#..............#...
...#....................#...................................#..##...................#.......#......................###.........#..
....................#............#....#.##....#.........#......#...#........................#.......................#..........#..
..............#...................................................................................#....................#..........
.........#................#..............................#............................#...#.................#...............#.....
............................................................................................#...#............................#....
............#....................#................................#....#...............................#....#.....................
........................................#.........#..................................................#..#..................#......
.............#.#............................#..#.....#............................................#....#..........................
................................................................................................#.........#..#..............#..#..
...........#..........#.#..#................#.#..#...#.........#..........................................#..........#..#.........
.............................#....................#.......#....#.....#....#......#....................#..#...............##.......
..........#..............................................................................#....#.........#..#................#.....
..#..#...............................................................#.......#........#...........................#...............
...........................................................................#...##....................#.#....##....................
.......................................#...............................................#.....................#.........#..........
.......................................................#.......#....#................#.....................................#......
.............#................#...................#.................#....................#..................#.#.........#.........
.....................................................................#.....................................#......................
........................#..........................................#....#..#.#..........................................#.........
............#.......#..................#.................................................#..............#.......................#.
.........................................................#...............#...#....#...........#.................................#.
.........................#..........................#..#........................................................#.................
...............#....................................#.......#......................................#............#.................
.#......................................................................................................#.........................
#...#........................................................#.................#....#....................#...........#............
..#.........#................................................................#................................#.............#.....
..................................#.........................................................................#................#....
..............#..............................................#........#..................................#........................
......#............................................#.................................#............................#...............
.......##..#.......................##............#...#...................#.#..........................................##..........
.#......#.....................................................................#..#..........................#......#.............#
.................#.....................#........##..#.........#........#................#.........................................
...........#.....#..........#........#............................................................................................
.........................#......#.......................................#..............................#..........................
............#............................................................#..............#..............................#..........
..................#.........#...........................................................................................#.........
#.#..................................#....................#......................#.............#.................................#
....#................#.................#...................#...........#......................................#...................
................#........................................................................................#....#.#.......#.....##..
..........#...#.......................................#........#.......................................#...#......................
.......#..##........................#......##.........................#.........#.......#.............................#.....#.....
................#...............................................#....#..........#.....#.........#.........#.........#.............
...............................#............#....................................#......#......................................#..
.#..#..................#............................................#....#............#...............##...#..........#...........
....#.............................................................................................................................
.............................................................#...........................#..........#.............................
.#........#..................#.....#.............#.....................................................#...#........#...........#.
.......................#........................................#.....#............................#.#..................#.........
................#....#................#.......#............................#.......#.................#............................
....#.........#....#........#.....................#........................#............#.........................................
.......#.......#.....................................................................##...........#...............................
...........#.........................................................#..........#............#....................................
..................#.............................#.......................................................................#.........
................#.....#........#.....#...#..........#.....................................#.....#........................#........
..........................................#.........#...........#.................................................................
...#.......................................................................................................#......................
....#..............#...........#..................................................#.................#.................#...........
.#................#.....#.#.................................................................#.........................#...........
............#.........................##....................................#..............#......................................
...##...........#...#............#..........................................................................#.....................
............................................#......................#......#.......................................................
............#............................................................................................................#........
...................##..............#.#....#.##...................................................#..................#.............
..#...................................................................................#.........#.........................#.....#.
........................#..............................................#......#................................................#..
................#............#............................#.#...................#.....................#...........................
..................#......#................#.#......................#...................#...#......................................
..#................................................##...................................................................#.........
...........................#......................................................................#......#...#......#.............
........................#...#........#......#.......#..........#.............................#........#.....#.....................
.................................................#..............................................#......#.....#....................
.....#....#.................#......#........#.#..............^...........................#...................#..#.................
.............................................................................#................................#...................
#..........................#..#..............#.......#..........................#.................................................
............#.............................................................................#...................#...................
..................#.............................#.........................................#................#.........#......#.....
...#...............................#.....#......#............###.#.#.....................................#....#.............#.....
...........#...........#...........................#..............................................................................
............#..........................................#.....#.............#..........................#....................#.....#
........................#......#..#............................#.......................................................#..........
..#...#...#.......#.#..........................................#.............#.........#....#..................#...........#......
..................#.......#.....................................................................................#........#........
......##................#...........................................#..............##.................................#...........
.................#................................................................................#.#....................#........
....................#.........#..........#...............#...#...#.#.#............................................................
#..................#.#..........#..#...................................................................................#..........
..........#........................................................#..........##..........................#..##...................
...........#...................................................................#..................................................
..................#........#............................................#..................#....#.......................#..#......
............#...................#......#..........................................................................................
...........................#.....##..........#.#..............#......................#.............#.......#...........#..........
............#..................................................#.......#.........#.#..................#..............##...........
#..................................................#...#......#..#......................#.............#........#............#.....
....#..................#..........#.........#.........................................#..................#................#.......
...#.................#.............................................................................#....................#.........
..........#.................................................................#............#....................#.#.#.....#.........
.....................#......................#...........#........#................................................................
.....#.......................................................................#......................#...#......#..................
.............##........#.....................#...........##........#............#.....#.....................#...............#.....
.....#.........#....#.................#....#...........#.......##..........#.........#.#......................................#...
.......#..................##.......#...#.#...#...................................#.......................................#.....#..
...............#.......#.................#........................................................................................
......#.......#.....#...............................#...........#.......#......................##...#....#........................
.##..........................##..................##................#..#....#...##.................................................
........#..............................#.#......#........#...............#....#........#.#........................................
...............................#..#.....................#.#...................#...................................................
.....................#.................................................##...#.......#.................##...............#.......#..
.............#..........................#.................................#..............#.......#..........#........#............
.........................................#...................#.........................................................#..........
...............................#..........#..............................#............#.....#.....................................
.............#..........................#....................#................................#...#............#..................
....#......#........#.......#......#................................................#...#......................................##.
..#...................................#........#.....................................#...#......#.........#..#..........#.........
.......#.........#................................................................................................................
...........#...............................##.........................................#..#....................#.....#.#.......##..
.........................#..#...............#............................#.............#..........................#..............#'

drop table if exists #Route
drop table if exists #Obstacles

;with i as
	(select c.[value] X, r.ordinal Y, substring(r.[value], c.[value], 1) Symbol, len(r.[value]) MaxX, count(*) over(partition by r.ordinal) MaxY
		from string_split(replace(@Input, char(10), ''), char(13), 1) r
			cross apply generate_series(cast(1 as int), cast(len(r.[value]) as int)) c
	)
	, Maxes as
	(select top 1 MaxX, MaxY
		from i
	)
	, i1 as
	(
	select X, Y, Symbol
		from i
		union
		select [value] X, Y, '' Symbol
		from Maxes
			cross apply generate_series(cast(1 as int), cast(MaxX as int))
			cross apply (values(0)
							, (MaxY + 1)
						) v(Y)
		union
		select X, [value] Y, '' Symbol
		from Maxes
			cross apply generate_series(cast(1 as int), cast(MaxY as int))
			cross apply (values(0)
							, (MaxX + 1)
						) v(X)
	)
insert into AOC_2024_Day06_Map
select row_number() over(order by Y, X) ID, *
from i1

create unique clustered index IX_AOC_2024_Day06_Map on AOC_2024_Day06_Map(ID)
create unique index IX_AOC_2024_Day06_Map_1 on AOC_2024_Day06_Map(X, Y) include(Symbol)

insert into AOC_2024_Day06_Rel
select m.ID fID, l1.ID tID, Rt, l.Symbol, '>' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X - 1 X, o.Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y = m.Y
						and o.X > m.X
					order by o.X
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat([value], '.', m.Y) p, '>' d
							from generate_series(m.X, l.X)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol  = '#'
					and o.X = m.X
						and o.Y = m.Y - 1
					)
	and not exists (select *
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.X = m.X
							and o.Y = m.Y + 1
						)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, '<' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X + 1 X, o.Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y = m.Y
						and o.X < m.X
					order by o.X desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat([value], '.', m.Y) p, '<' d
							from generate_series(l.X, m.X)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X
						and o.Y = m.Y + 1
					)
	and not exists (select *
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.X = m.X
							and o.Y = m.Y - 1
						)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, 'v' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y - 1 Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y > m.Y
						and o.X = m.X
					order by o.Y
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, 'v' d
							from generate_series(m.Y, l.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X + 1
						and o.Y = m.Y
					)
	and not exists (select *
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.X = m.X - 1
							and o.Y = m.Y
						)
	and not (m.X = l.X and m.Y = l.Y)
union all
select  m.ID fID, l1.ID tID, Rt, l.Symbol, '^' Dir
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y + 1 Y, o.Symbol, o.ID
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y < m.Y
						and o.X = m.X
					order by o.Y desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X
						and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, '^' d
							from generate_series(l.Y, m.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol not in ('#', '')
	and exists (select *
				from AOC_2024_Day06_Map o
				where o.Symbol = '#'
					and o.X = m.X - 1
						and o.Y = m.Y
					)
	and not exists (select *
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.X = m.X + 1
							and o.Y = m.Y
						)
	and not (m.X = l.X and m.Y = l.Y)
union all
select m.ID FromID, l1.ID ToID, Rt, m.Symbol, '^'
from AOC_2024_Day06_Map m
	cross apply (select top 1 o.X, o.Y + 1 Y, o.Symbol
					from AOC_2024_Day06_Map o
					where o.Symbol in ('#', '')
						and o.Y < m.Y
						and o.X = m.X
					order by o.Y desc
				) l
	inner join AOC_2024_Day06_Map l1 on l1.X = l.X and l1.Y = l.Y
	cross apply (select (select concat(m.X, '.', [value]) p, '^' d
							from generate_series(l.Y, m.Y)
							for json path, without_array_wrapper
						) Rt
				) p1
where m.Symbol = '^'

create unique clustered index IX_AOC_2024_Day06_Rel on AOC_2024_Day06_Rel(FromID)

;with sp as
	(select r.FromID, r.ToID, m.X, m.Y, r.Rt, m1.Symbol
		from AOC_2024_Day06_Rel r
			inner join AOC_2024_Day06_Map m on m.ID = r.ToID
			inner join AOC_2024_Day06_Map m1 on m1.X = m.X
											and m1.Y = m.Y - 1
		where r.Symbol = '^'
	)
	, rec as
	(select FromID, ToID, X, Y, RT, cast(RT as varchar(max)) PartialRt, Symbol, 1 Steps
		from sp
		union all
		select r.ToID, l.ToID, m.X, m.Y, r.RT + ',' + l.Rt, l.Rt PartialRt, l.Symbol, r.Steps + 1 Steps
		from rec r
			inner join AOC_2024_Day06_Rel l on l.FromID = r.ToID
			inner join AOC_2024_Day06_Map m on m.ID = l.ToID
		where r.Symbol != ''
	)
select *
into #Route
from rec
order by Steps desc
option (maxrecursion 32767)

;with r as
	(select top 1 Rt
		from #Route
		order by Steps desc
	)
select count(distinct json_value([value], '$.p')) Answer1
from #Route
	cross apply openjson('[' + Rt + ']')