drop table if exists AOC_2024_Day18_Bytes
create table AOC_2024_Day18_Bytes(ID int,
									X int,
									Y int
									)
create unique clustered index IX_AOC_2024_Day18_Bytes on AOC_2024_Day18_Bytes(X, Y, ID)
GO
create or alter function fn_AOC_2024_Day18_Step(@Routes varchar(max)
												, @MaxX int
												, @MaxY int
												, @MaxByteID int
												, @Sort bit
												) returns table
as
return with NewRoutes as
			(select isnull(m.X, r.X) X, isnull(m.Y, r.Y) Y, iif(IsActiveRoute = 1, concat(r.Rt, Rt1, ','), r.Rt) Rt, IsActiveRoute
				from openjson(@Routes)
					cross apply (select cast(json_value([value], '$.x') as int) X
									, cast(json_value([value], '$.y') as int) Y
									, json_value([value], '$.r') Rt
								) r
					cross apply (select iif(r.X = @MaxX and r.Y = @MaxY, 0, 1) IsActiveRoute) i
					outer apply (select *
									from (values(r.X, r.Y + 1)
												, (r.X, r.Y - 1)
												, (r.X + 1, r.Y)
												, (r.X - 1, r.Y)
											) m(X, Y)
											cross apply (select concat(m.X, '.', m.Y) Rt1
															where m.X between 0 and @MaxX
																and m.Y between 0 and @MaxY
																and not exists (select *
																				from AOC_2024_Day18_Bytes b
																				where b.X = m.X
																					and b.Y = m.Y
																					and b.ID <= @MaxByteID
																				)
														) n
									where IsActiveRoute = 1
								) m
				where IsActiveRoute = 0
					or Rt not like '%,' + Rt1 + ',%'
			)
			, UniqueRoutes as
			(select distinct X, Y, isnull(SortedRt, Rt) Rt, IsActiveRoute
				from NewRoutes
					outer apply (select ',' + string_agg(cast([value] as varchar(max)), ',') within group (order by [value]) + ',' SortedRt
									from string_split(Rt, ',')
									where [value] != ''
										and IsActiveRoute = 1
										and @Sort = 1
								) s
			)
			select '[' + string_agg(cast(concat('{"x":', X, ',"y":', Y, ',"r":"', Rt, '"}') as varchar(max)), ',') + ']' Rts, max(IsActiveRoute) HasActiveRoutes
			from UniqueRoutes
GO
declare @Input varchar(max) =
'37,6
59,27
7,34
69,29
58,41
3,23
9,31
23,3
13,21
3,6
35,17
27,62
45,67
0,25
17,26
31,11
63,69
65,54
15,15
5,35
7,9
21,21
53,61
33,10
28,13
63,42
5,41
29,67
47,4
64,57
69,60
25,7
69,65
61,39
57,38
65,44
29,65
69,58
1,28
5,11
61,42
16,27
61,35
65,57
39,5
7,45
34,15
11,25
20,15
34,13
39,15
7,32
6,19
63,62
11,69
1,30
27,65
49,68
29,10
23,67
33,70
7,27
41,61
37,12
27,1
63,53
24,1
25,8
32,67
6,27
26,69
40,55
58,25
63,25
47,28
67,42
37,9
33,25
1,23
58,45
52,43
27,5
29,16
9,22
43,49
57,29
33,63
27,19
41,17
59,64
19,20
65,39
51,56
35,69
43,59
65,67
7,33
41,62
61,34
51,70
21,65
1,3
64,41
39,11
61,31
57,48
8,31
57,52
31,69
63,29
29,13
38,61
62,39
62,69
43,61
19,27
6,23
61,44
39,58
13,2
23,23
37,65
15,27
44,61
27,3
19,24
27,9
13,20
53,59
41,13
7,17
56,65
9,18
51,49
9,19
5,15
11,26
65,28
3,2
62,49
45,56
62,59
33,15
29,17
51,46
55,34
67,65
45,65
21,32
51,63
64,65
56,23
12,25
59,25
35,65
25,21
41,51
47,48
34,1
64,27
26,11
54,59
5,8
59,67
35,26
0,19
52,47
5,1
53,47
62,65
11,11
61,29
69,63
47,46
3,14
13,18
49,59
65,59
29,69
21,28
35,66
61,27
65,31
57,25
25,19
53,69
67,68
52,27
21,18
0,7
45,46
16,29
14,29
63,57
62,55
48,37
67,64
43,56
41,10
2,5
49,63
68,69
49,67
7,1
70,53
37,8
3,37
41,55
13,15
41,64
47,53
33,9
17,63
66,33
15,7
47,63
65,51
55,30
19,62
17,18
43,42
19,61
1,15
26,61
64,69
47,66
25,18
69,51
51,69
65,33
19,68
52,51
43,11
11,2
38,67
49,54
41,15
66,67
54,27
43,69
67,35
41,67
6,25
37,19
19,25
21,12
8,5
24,25
5,31
8,23
47,56
21,25
39,62
8,9
35,68
58,57
50,65
46,59
19,23
7,29
69,31
5,21
3,28
39,59
61,67
19,69
1,13
56,59
67,46
59,50
31,15
56,63
45,55
49,55
60,51
16,21
24,61
31,17
69,66
64,55
19,3
7,2
3,11
45,61
21,13
55,51
5,27
41,63
65,66
2,9
17,62
3,32
59,43
53,39
67,53
16,65
25,6
34,11
31,20
10,43
65,40
63,34
53,51
45,44
7,25
56,49
43,6
65,46
67,47
9,3
21,3
5,7
2,3
48,7
5,30
13,23
69,34
53,54
53,62
8,35
61,45
30,1
16,3
68,49
19,2
28,15
9,23
31,12
59,34
29,1
69,59
61,41
58,23
25,69
26,65
14,7
69,64
17,23
68,29
47,55
7,44
19,67
63,67
69,32
65,58
69,56
37,11
44,65
66,35
2,25
23,5
49,57
33,66
19,5
60,27
25,61
30,65
9,39
63,45
24,13
13,33
16,67
47,10
27,11
52,57
7,5
23,68
23,9
47,67
5,9
8,3
67,69
65,48
41,8
59,47
39,66
20,5
49,58
59,62
25,63
17,5
61,33
37,14
15,21
9,1
65,32
56,43
39,14
39,13
25,34
10,27
9,44
1,16
7,12
33,69
5,3
45,13
69,26
37,67
63,52
0,15
61,52
3,17
55,61
69,55
53,65
29,2
59,53
43,7
9,29
45,11
9,40
22,63
69,62
42,15
22,5
49,50
58,61
23,70
45,41
35,20
55,63
3,41
38,7
3,30
3,19
50,49
20,21
25,10
12,9
41,6
6,37
45,59
29,5
67,52
1,29
1,11
69,50
9,35
3,1
42,67
38,3
12,39
65,35
7,20
21,11
60,49
47,69
9,36
51,65
35,18
18,19
1,12
63,47
6,49
12,27
33,18
42,65
59,41
16,5
25,24
13,29
9,2
25,9
43,58
61,56
41,5
17,25
37,7
21,10
30,17
1,21
67,54
6,47
1,25
25,5
60,59
28,5
45,58
45,6
66,49
63,48
65,41
11,29
39,63
7,38
23,57
40,69
58,67
59,69
3,27
43,67
26,1
30,69
47,64
33,13
51,67
7,30
3,8
48,53
17,1
61,43
49,49
16,1
21,62
35,4
7,23
57,47
59,61
59,29
23,6
64,35
19,1
11,17
11,30
17,21
19,21
31,1
45,7
18,5
38,63
27,69
9,43
17,67
59,59
47,62
45,45
7,3
63,43
59,49
43,65
44,63
57,61
11,1
9,17
18,25
26,15
4,37
4,25
41,11
55,53
5,33
22,67
61,53
10,23
37,64
57,46
27,13
33,11
64,51
25,64
8,17
55,49
62,29
21,1
59,23
20,61
32,17
49,41
29,4
7,39
61,54
3,15
67,30
37,61
11,7
61,36
25,14
53,55
53,64
21,67
54,49
45,47
63,35
40,67
49,66
31,3
57,65
7,43
4,11
11,3
57,59
18,59
69,35
13,28
65,36
15,23
67,57
28,3
61,57
39,60
15,10
37,13
49,65
30,13
14,1
13,6
57,66
3,18
57,45
41,57
45,68
5,34
7,13
1,10
1,1
54,69
23,11
55,70
3,31
5,16
11,19
65,38
56,47
5,2
1,27
46,53
67,49
69,67
54,63
34,61
36,13
19,38
35,13
66,51
64,31
20,1
29,11
14,23
59,36
70,25
55,59
63,64
5,40
51,62
62,45
31,7
65,55
25,59
7,41
53,27
50,63
69,68
57,63
43,12
23,17
21,7
9,21
7,15
39,8
55,57
55,27
31,14
65,60
63,46
31,19
9,24
57,28
46,65
59,57
5,17
65,69
59,22
9,5
6,13
25,15
2,45
27,17
25,65
7,19
3,20
55,55
5,25
29,15
25,11
3,26
9,0
21,64
22,1
24,11
28,65
21,9
32,11
59,32
63,41
50,27
21,15
61,66
11,18
44,67
51,55
47,57
11,23
54,67
30,11
1,7
7,35
67,63
39,69
57,55
5,5
23,59
54,45
69,27
10,69
7,37
14,39
48,41
9,37
15,5
41,7
1,43
14,3
5,4
17,11
1,5
30,7
42,69
23,66
22,23
45,51
57,51
41,65
15,68
23,8
65,37
61,49
27,63
19,22
49,53
11,22
24,3
7,31
39,16
50,45
44,51
37,2
9,7
37,69
67,55
57,56
68,55
69,69
3,21
63,65
63,38
19,65
23,2
23,61
45,50
43,8
37,10
51,59
45,57
37,68
59,38
22,9
57,41
52,59
57,54
62,31
57,60
60,43
6,17
55,69
38,11
45,54
13,24
48,69
17,31
7,21
42,55
55,29
39,65
27,15
28,69
19,11
39,67
53,49
66,25
56,57
57,69
3,34
12,5
17,60
36,15
21,5
3,7
63,39
65,45
13,25
27,8
43,54
61,69
15,1
67,33
64,43
5,37
41,9
15,24
65,63
33,58
53,33
65,47
11,66
9,38
35,15
25,68
37,63
63,30
47,50
4,19
47,65
46,69
58,69
1,0
43,57
4,33
56,27
63,37
39,57
59,51
11,5
63,68
49,44
63,26
67,51
57,67
2,23
19,63
28,11
26,5
60,65
43,5
54,51
5,19
23,63
58,53
3,39
48,61
51,68
41,69
57,49
51,47
55,67
65,25
11,31
33,16
59,63
59,30
49,61
6,5
5,45
60,25
65,49
11,27
5,28
5,10
69,53
51,52
63,55
52,65
39,55
5,44
10,5
49,51
41,12
59,37
5,36
4,41
51,57
51,53
4,15
65,27
1,9
59,65
23,26
48,57
21,4
13,7
39,70
57,27
18,69
2,17
1,4
63,33
69,28
69,61
56,61
66,29
25,4
45,35
7,46
12,21
2,13
23,13
25,67
22,19
45,69
53,57
31,68
25,1
52,67
55,65
60,29
59,58
35,11
18,3
13,31
22,13
9,10
51,61
4,23
40,65
7,7
14,11
69,52
17,27
21,61
4,1
67,31
11,34
60,69
31,0
16,7
55,56
62,27
31,9
50,59
5,13
19,19
43,9
59,35
47,60
39,56
40,5
62,57
23,65
2,41
15,32
55,44
29,63
23,1
25,17
32,21
43,4
65,29
1,39
63,49
8,27
5,6
23,7
14,21
39,20
9,27
39,4
56,33
49,52
61,60
45,63
9,25
43,63
61,37
3,35
65,53
6,41
19,64
47,51
49,69
39,9
35,8
11,42
16,25
25,13
25,3
6,11
39,7
17,22
5,29
57,26
13,3
35,63
63,51
59,68
34,67
5,22
3,3
37,5
43,13
53,67
9,20
7,28
23,69
5,39
40,15
40,11
60,55
14,5
51,50
68,33
19,66
29,66
37,15
52,41
61,40
62,37
25,16
3,29
35,61
59,39
47,59
36,61
59,55
51,60
69,57
36,65
55,66
24,63
55,25
37,3
61,32
13,19
11,4
8,41
10,29
17,3
43,40
44,17
54,35
37,49
3,38
41,23
60,5
21,54
36,21
25,46
51,29
53,7
1,17
55,11
51,17
29,3
33,31
55,41
33,65
8,49
69,47
39,61
62,21
31,30
40,1
56,9
3,5
55,19
26,21
27,51
46,9
58,21
35,59
49,8
65,8
43,39
51,28
69,20
35,3
43,18
1,36
4,59
28,45
12,59
45,30
9,63
50,17
35,22
49,23
2,53
33,49
45,5
66,15
9,60
62,11
35,1
47,45
19,47
51,30
25,43
49,25
27,36
15,31
21,22
43,53
67,58
31,29
23,51
38,31
25,29
9,55
9,59
31,33
29,39
8,69
7,53
11,39
47,33
17,69
24,37
5,68
57,5
41,45
53,45
29,20
41,32
14,35
25,55
19,31
2,67
49,33
35,62
47,21
25,53
39,36
29,21
15,46
17,13
3,69
35,25
41,1
49,35
23,25
5,70
55,23
1,59
3,13
13,47
13,51
65,3
65,21
16,47
27,33
45,62
35,5
43,15
47,12
1,40
51,27
51,19
21,69
5,67
19,12
23,55
51,43
59,14
41,39
53,25
57,31
31,8
61,5
60,7
39,51
29,41
40,27
5,55
61,47
51,12
9,65
0,43
29,42
24,33
18,35
21,17
59,33
35,53
32,41
36,43
45,29
18,33
5,57
54,5
68,43
29,64
4,47
11,14
34,31
17,41
53,43
33,53
57,17
30,59
9,33
55,35
13,27
17,51
21,68
11,68
15,65
42,51
21,29
45,52
25,41
43,60
3,62
15,33
56,1
31,32
29,47
23,30
21,41
29,55
38,41
24,55
33,64
64,19
5,58
51,13
38,23
1,35
35,29
57,13
5,43
59,4
19,35
11,32
5,59
40,45
19,53
50,11
54,9
11,52
5,66
7,67
20,55
41,40
43,29
20,39
43,20
31,51
27,59
25,48
49,48
51,36
41,2
23,21
56,37
41,33
46,21
57,16
29,33
41,43
53,23
67,41
13,45
15,59
9,16
47,43
7,48
65,9
41,19
65,15
18,43
61,12
27,28
58,43
49,29
44,11
61,19
1,64
31,49
15,62
68,19
55,33
49,9
39,46
66,21
37,59
17,65
33,60
31,35
21,39
21,59
29,7
36,35
11,36
67,1
17,53
29,57
23,43
29,43
57,37
1,56
34,23
51,21
33,39
7,49
70,39
43,34
55,9
1,49
51,33
16,59
52,37
49,7
23,44
45,21
22,51
35,23
27,21
34,45
41,58
63,27
15,37
31,61
32,47
61,20
48,23
17,35
53,63
39,1
21,19
31,5
42,17
25,47
18,55
33,38
49,14
53,37
11,58
19,14
7,57
29,38
43,43
49,38
48,29
25,31
41,48
7,11
40,31
1,53
62,25
37,52
21,42
49,2
27,67
59,1
64,15
31,57
67,23
8,55
17,7
11,33
29,34
40,29
35,19
68,39
70,13
38,39
29,58
54,37
65,23
16,35
27,49
0,55
63,7
55,7
23,58
44,9
43,30
14,31
41,31
36,33
3,9
11,67
14,55
25,56
27,39
54,15
40,19
43,36
61,61
47,31
39,27
45,25
42,13
37,25
70,17
0,63
27,42
9,47
58,11
15,19
18,51
11,55
39,23
3,25
31,28
14,61
12,63
37,28
12,61
33,21
20,7
47,61
39,50
1,48
48,45
9,62
35,51
4,53
6,53
35,41
57,50
39,43
34,41
39,25
21,34
53,4
40,23
13,11
51,39
3,55
45,17
53,14
7,55
13,37
27,54
25,39
29,29
62,3
15,14
54,53
19,17
60,1
55,2
54,11
49,1
47,29
31,63
17,19
57,43
33,1
7,51
49,4
53,44
11,47
55,39
17,29
31,24
9,54
67,13
39,17
59,3
11,43
1,33
22,39
66,1
3,53
26,29
9,57
26,67
37,21
50,19
69,40
19,45
39,33
13,56
35,47
23,47
59,45
21,49
54,1
13,41
57,7
61,18
3,51
51,37
37,57
25,54
37,45
3,59
22,45
29,51
34,39
33,29
49,26
11,15
67,17
43,1
1,58
13,67
1,37
32,3
49,0
34,37
61,62
41,29
53,17
11,38
10,65
29,37
1,45
36,53
39,29
18,9
35,42
61,59
60,21
69,17
55,12
53,41
37,23
39,39
43,51
1,61
36,29
27,61
51,54
45,37
5,65
57,11
23,52
3,43
15,50
68,11
56,31
43,21
9,53
25,58
55,5
29,45
69,5
10,61
63,19
48,31
24,59
45,53
61,7
27,31
49,34
23,41
33,27
63,13
39,49
56,13
29,49
3,60
15,61
17,43
43,33
14,43
13,9
1,68
17,61
47,37
63,15
29,24
46,35
41,35
67,61
31,37
25,57
45,23
31,67
12,31
21,27
45,26
47,15
4,69
21,47
56,19
61,23
33,37
65,12
7,58
19,55
30,33
2,21
59,7
66,63
47,7
39,54
13,35
45,39
20,47
39,41
55,31
69,39
59,5
55,17
69,11
53,32
37,56
29,40
58,17
67,39
52,3
33,35
30,43
1,57
52,21
14,59
46,39
56,7
15,38
12,13
51,14
11,51
47,1
63,17
12,69
33,2
41,49
33,32
25,35
23,45
67,5
21,38
29,18
42,3
52,39
1,41
31,53
51,5
17,49
34,29
8,57
5,53
69,8
64,21
57,4
57,14
63,31
33,28
27,43
64,3
55,15
41,60
48,19
32,7
27,7
49,15
69,7
7,47
37,27
25,32
49,27
56,11
46,5
37,50
53,18
21,53
37,40
18,37
13,69
47,17
59,31
10,51
62,1
38,19
51,35
61,11
25,33
6,61
45,19
66,41
11,9
49,45
15,42
69,25
45,1
52,11
42,23
0,49
23,48
35,57
7,63
28,55
22,15
47,11
37,46
48,11
15,49
53,11
3,65
47,26
23,39
23,49
36,55
69,41
35,6
11,21
59,9
47,35
55,24
13,57
39,26
31,27
57,21
53,13
53,9
1,47
37,33
54,47
47,23
15,54
56,17
43,23
68,37
31,31
33,54
45,33
4,63
53,20
22,41
31,38
5,51
21,45
2,61
54,41
66,19
39,3
47,16
53,58
5,61
27,55
19,50
47,3
15,69
50,31
61,3
27,45
35,49
15,55
63,16
33,23
5,69
69,10
23,34
49,17
21,23
36,39
58,9
17,10
13,61
3,47
1,69
20,35
18,13
23,46
69,44
12,17
29,46
19,7
9,14
61,63
19,52
37,35
55,47
50,5
31,25
25,28
57,9
47,24
40,37
61,24
37,18
51,8
16,53
61,2
33,17
68,23
51,1
30,61
53,3
14,17
49,42
33,51
49,20
50,39
57,40
15,47
41,44
26,51
8,15
55,37
67,6
37,55
30,37
19,59
41,21
13,16
39,21
18,45
45,32
29,23
65,1
65,19
23,42
17,15
65,18
23,20
13,34
67,21
29,26
57,23
68,3
36,37
9,12
61,65
45,14
59,13
41,41
63,9
15,43
19,48
27,26
25,22
31,48
19,57
11,41
48,15
63,23
19,28
53,35
4,43
19,15
13,36
34,51
7,60
55,6
38,49
39,22
45,15
33,61
69,43
21,57
31,59
4,49
3,45
17,39
43,47
68,9
10,53
31,43
41,20
37,17
33,46
33,67
19,30
69,45
21,31
46,41
19,58
48,35
57,35
18,31
36,47
21,43
53,29
25,45
43,31
54,33
14,49
49,13
7,64
13,39
30,51
13,63
1,65
5,63
65,14
67,25
11,37
18,65
17,8
33,3
61,16
67,45
32,55
3,64
59,21
28,59
38,25
13,43
23,33
32,5
13,49
23,29
31,21
8,51
67,7
17,9
12,51
9,41
17,59
63,21
67,59
17,30
14,65
45,49
39,47
11,49
27,35
47,5
47,47
45,22
50,35
36,25
61,13
37,43
37,16
9,13
15,11
43,32
29,62
58,35
15,3
31,22
45,9
13,58
69,23
17,16
43,41
21,60
53,19
37,36
61,55
1,63
16,39
67,3
39,19
27,27
11,59
23,37
11,45
43,38
35,55
61,21
67,15
44,15
50,23
29,59
45,0
25,42
5,56
9,69
3,33
21,51
55,3
16,49
30,27
67,43
61,25
64,1
25,51
29,53
11,8
26,47
38,43
49,19
70,47
2,37
51,51
13,13
34,7
13,65
7,8
11,57
54,55
8,67
38,29
45,38
29,27
37,29
13,55
21,37
63,59
67,60
31,58
37,44
47,39
42,25
31,13
63,61
65,24
67,26
33,5
3,63
13,46
30,47
21,56
21,63
29,19
35,9
17,37
65,5
21,33
53,1
53,24
13,1
42,29
47,2
5,49
34,33
19,29
31,56
56,41
52,1
67,37
16,57
23,16
51,7
15,9
52,25
11,50
67,22
52,33
28,29
53,16
27,29
33,41
67,67
51,16
35,24
53,53
60,15
20,31
67,62
27,57
49,3
26,41
21,24
9,51
45,24
22,31
15,40
9,67
29,31
54,39
15,51
57,15
69,33
59,19
60,47
7,61
31,40
51,42
17,40
49,18
20,43
69,19
32,43
42,35
15,64
53,15
37,47
19,33
69,21
55,21
43,35
10,7
13,54
41,38
61,9
33,45
23,27
46,43
64,11
51,31
35,67
41,52
43,55
25,37
27,52
27,32
0,31
17,70
35,37
35,39
59,15
26,19
59,17
66,9
31,45
25,25
25,40
39,31
49,31
27,25
7,65
62,9
33,33
33,43
43,27
17,56
15,45
15,25
19,39
17,33
26,37
9,11
55,13
17,55
58,3
1,34
51,3
22,49
19,16
3,50
46,29
57,57
1,55
67,11
68,17
68,5
26,57
19,41
13,5
40,33
49,39
3,54
29,9
29,25
41,47
38,53
15,39
57,1
53,31
58,31
17,42
45,36
30,53
27,47
59,11
23,36
49,11
32,35
11,56
23,53
65,61
42,1
68,13
57,39
54,25
63,63
33,7
55,43
36,1
36,31
63,1
60,11
3,57
70,3
18,47
12,41
43,44
33,26
65,4
41,25
28,49
5,23
5,47
34,49
19,8
12,45
33,47
9,45
35,21
54,29
33,48
49,6
15,63
16,13
35,7
59,6
55,1
35,33
58,1
3,67
47,13
27,44
43,19
19,51
51,45
21,55
64,23
20,51
30,23
51,10
34,35
22,59
37,37
39,37
61,51
28,7
11,61
35,31
42,47
35,35
69,37
17,36
23,15
60,9
27,23
37,41
59,46
25,27
16,19
43,17
34,57
31,39
8,65
40,41
49,37
39,53
34,3
37,51
63,11
24,51
51,11
15,35
45,27
19,13
35,43
23,19
45,2
19,9
39,45
41,37
41,59
31,47
11,48
57,19
11,12
63,14
44,41
67,9
9,15
62,17
46,13
57,3
65,65
25,49
46,17
53,5
15,29
15,17
62,5
17,57
11,64
26,31
3,42
49,32
29,50
9,61
36,59
1,44
28,21
15,57
15,52
31,23
3,46
5,64
17,47
25,44
49,43
49,40
11,10
65,43
7,62
3,49
63,6
29,35
67,27
27,50
7,59
67,56
69,1
24,19
23,31
47,41
23,35
3,61
11,63
37,48
45,18
33,59
20,45
45,43
13,48
6,55
11,13
45,20
44,5
32,53
47,27
44,29
33,55
37,53
14,69
67,19
53,22
55,8
39,35
28,23
31,65
37,1
22,55
14,13
35,27
13,59
11,65
19,40
9,9
43,25
68,47
29,61
65,13
27,41
27,37
15,67
41,53
15,53
52,31
51,23
10,47
63,3
24,29
15,41
16,33
13,66
49,21
2,51
56,21
1,67
27,18
10,57
34,21
32,63
3,56
26,25
67,4
41,27
43,37
17,45
65,6
6,67
43,46
49,22
41,42
65,7
32,29
57,33
19,43
46,47
28,35
25,38
1,51
59,18
45,31
35,50
13,44
63,8
43,48
57,53
40,49
61,17
51,41
65,11
44,27
67,36
7,69
66,17
52,5
16,15
68,1
69,49
6,51
13,17
35,45
51,9
17,17
30,5
33,57
53,21
68,15
46,33
49,5
64,61
31,36
51,25
27,53
10,41
55,45
65,17
45,3
61,1
69,9
31,44
47,9
19,49
28,39
52,7
27,60
63,5
51,15
25,23
10,33
29,56
11,53
47,19
43,3
1,31
14,9
39,34
37,39
34,55
33,52
69,3
37,31
69,13
5,52
31,41
9,46
61,15
67,29
28,31
13,53
32,61
41,3
47,49
9,49
43,26
54,19
21,35
67,24
11,35
47,25
43,45
19,37
37,58
69,15
41,24
15,13
65,10
1,66
33,19
18,53
21,26
31,55
1,19
49,47
12,60
54,17
2,20
18,38
16,51
8,25
30,42
32,52
2,44
4,28
2,40
6,20
30,49
32,48
0,33
18,67
0,4
11,6
26,44
58,62
29,0
24,68
36,28
69,38
22,21
11,20
20,69
14,15
54,31
8,54
25,66
65,50
4,68
35,2
2,69
68,64
44,18
70,20
20,36
2,11
12,30
26,27
35,56
39,6
12,38
56,66
34,56
62,33
38,12
20,63
62,14
38,13
48,63
52,20
0,20
12,55
32,54
12,68
30,48
42,9
16,62
15,34
0,8
30,46
16,6
31,18
18,11
26,33
11,28
37,38
4,27
40,70
43,2
28,38
54,20
8,48
16,30
54,36
8,33
56,62
12,28
6,54
52,35
32,64
42,12
65,70
59,8
46,46
12,6
48,42
6,34
10,25
49,64
42,22
30,34
17,38
50,55
57,36
56,36
17,46
28,33
16,69
66,46
8,46
28,44
24,22
6,58
4,42
21,70
42,66
25,36
8,14
68,56
27,30
3,10
30,20
42,42
20,60
66,23
12,64
53,36
65,2
38,34
26,48
20,14
30,52
31,66
27,24
5,24
67,50
1,46
37,60
40,35
16,14
56,34
10,54
28,53
51,4
6,42
12,56
54,21
29,36
30,19
32,22
26,35
25,62
4,61
15,6
16,8
58,34
12,8
0,16
70,18
6,68
32,20
6,21
4,48
14,60
0,17
44,31
22,44
0,45
62,34
63,2
14,42
60,50
38,22
44,16
4,10
69,18
9,58
18,15
10,46
35,16
38,35
61,8
68,38
10,35
34,62
17,14
52,68
4,24
24,18
20,46
8,30
54,61
12,19
22,46
6,66
62,38
48,22
12,42
12,24
70,65
7,6
29,68
14,54
16,52
8,16
61,28
26,64
55,54
30,63
30,50
9,42
61,38
27,68
14,25
32,18
57,8
42,26
50,52
17,2
52,16
62,32
16,9
68,4
70,33
58,6
16,40
38,33
4,17
4,31
16,42
14,2
31,60
18,30
6,56
22,52
34,53
11,60
35,34
26,45
17,54
62,36
10,60
42,36
0,41
4,57
68,61
12,44
13,64
64,39
34,40
46,68
46,54
0,3
26,32
66,30
14,24
1,50
2,33
45,28
20,52
22,57
18,50
4,38
54,44
28,30
55,20
54,60
10,52
37,54
7,66
59,26
16,31
22,64
20,12
62,43
32,26
14,32
40,20
28,41
20,28
35,38
18,27
54,30
50,21
28,40
4,30
56,56
19,44
27,38
42,34
50,61
46,15
21,30
60,39
24,58
6,31
25,0
28,16
56,70
26,70
0,60
5,50
42,70
30,67
64,52
11,24
66,59
47,44
2,43
4,54
50,20
22,27
2,65
40,42
26,4
58,46
64,36
36,45
23,38
6,29
12,43
39,10
18,23
18,61
28,48
26,60
34,68
27,46
56,32
6,60
14,6
29,70
0,61
25,26
12,22
68,53
18,41
66,40
24,48
3,4
18,29
55,14
10,66
27,56
70,26
70,61
34,38
55,48
50,16
68,41
34,26
41,22
38,47
2,28
48,64
0,37
47,14
24,2
44,42
16,58
51,20
33,30
14,22
27,0
2,31
48,43
44,14
70,64
58,38
12,11
11,54
13,40
2,18
40,66
28,22
36,54
17,12
35,48
61,26
32,37
58,29
10,45
27,4
32,30
33,34
42,44
36,9
30,28
10,56
65,30
49,56
17,66
20,24
31,34
50,51
0,32
2,14
36,2
21,58
40,28
2,32
66,57
20,11
7,42
62,52
46,44
39,42
41,34
12,62
48,16
6,65
0,38
42,46
45,16
48,14
8,44
54,24
60,46
70,31
28,52
36,56
60,8
8,2
55,50
46,57
14,26
42,52
66,38
68,30
28,57
14,10
23,56
2,50
2,6
62,6
50,22
44,69
58,20
1,62
32,57
38,46
56,55
33,20
66,42
24,42
64,33
40,58
1,54
56,18
58,30
18,12
44,60
32,69
46,24
15,2
46,58
40,7
8,4
56,28
50,37
6,62
50,66
70,34
34,60
18,18
42,7
16,56
37,70
67,16
62,2
62,28
50,34
26,7
2,48
22,58
42,49
65,68
68,48
21,44
16,12
35,52
33,12
61,0
60,44
60,34
35,46
38,1
54,12
61,30
4,66
42,54
18,60
8,32
56,68
18,52
49,60
15,58
48,25
8,34
5,46
48,3
27,2
9,70
26,24
22,33
58,51
6,36
33,44
48,48
20,70
15,66
12,52
7,54
12,7
5,48
46,63
56,3
36,70
49,30
18,57
29,52
24,0
16,43
14,53
68,22
10,11
6,64
70,69
18,28
69,12
68,46
36,12
64,29
48,54
42,40
49,16
52,15
45,64
10,63
18,42
14,48
48,33
2,26
68,70
66,34
14,27
17,68
30,14
12,4
44,56
40,17
36,42
37,30
3,70
70,5
36,50
34,22
55,4
1,20
60,14
36,18
0,39
54,46
47,38
52,69
18,17
70,49
40,64
17,20
69,54
10,4
46,30
42,11
15,30
26,62
18,49
52,19
66,36
32,70
68,27
43,50
10,36
54,48
52,17
63,10
8,36
16,32
46,62
30,21
55,42
28,19
47,30
40,43
48,27
24,8
2,10
48,24
68,34
52,6
2,16
52,45
40,30
0,50
46,3
24,44
23,28
69,4
27,16
0,40
59,44
1,18
47,22
50,12
38,51
42,24
18,4
68,51
35,44
16,28
30,57
64,6
0,22
36,63
57,64
54,8
30,56
34,64
41,26
21,16
57,34
59,60
30,44
68,14
12,16
59,28
5,32
46,34
46,28
42,2
20,13
12,1
6,59
20,32
2,49
13,12
44,38
26,43
18,0
26,53
18,7
64,63
56,38
7,10
52,50
46,1
65,16
34,65
35,10
12,66
56,40
36,66
34,69
28,61
62,58
50,30
16,64
38,17
34,70
19,54
4,67
17,34
14,4
46,25
6,16
41,70
56,22
40,40
6,18
63,50
37,22
42,37
52,46
58,22
19,60
40,50
12,33
8,58
29,32
40,68
27,34
6,32
56,26
40,48
14,20
2,62
34,14
24,16
48,40
64,12
10,8
55,26
63,36
54,26
28,28
64,32
52,56
51,0
39,48
50,67
18,2
56,14
52,12
49,24
8,59
31,64
14,63
0,26
0,9
60,16
39,0
39,18
10,18
29,60
61,10
70,9
47,6
45,40
48,32
18,22
44,59
7,4
24,69
14,12
18,36
35,60
66,0
43,64
22,20
42,8
60,6
36,27
42,28
66,69
62,24
55,52
30,22
53,2
57,32
50,1
30,35
10,26
48,5
62,51
64,16
44,21
68,54
57,22
8,6
58,54
31,46
62,62
50,33
12,50
46,38
44,57
50,2
63,22
18,1
52,0
23,62
4,29
24,62
19,32
21,66
28,68
3,68
57,62
5,14
20,56
22,53
70,35
51,22
55,58
68,16
15,0
8,1
40,26
40,10
38,32
41,0
36,58
33,8
11,40
14,18
50,58
58,8
64,38
16,11
55,28
58,27
9,52
0,21
28,18
46,60
28,66
0,58
27,48
6,35
70,28
70,14
15,4
6,57
12,3
8,28
16,34
38,18
14,16
18,58
44,24
34,27
51,32
70,48
48,38
6,48
54,0
48,50
48,10
48,28
52,64
48,59
63,4
64,7
25,52
17,52
28,63
44,55
50,64
14,50
10,1
62,18
6,50
46,0
32,1
68,57
64,50
48,44
30,4
68,31
4,9
7,50
38,36
67,12
6,24
29,6
48,62
32,44
12,35
32,62
55,62
34,54
50,57
14,44
39,38
8,19
63,32
34,18
70,56
21,50
38,70
66,58
46,61
46,12
62,30
21,20
70,36
66,7
27,66
42,31
36,49
42,6
2,12
12,53
30,58
10,70
2,22
4,45
62,63
34,46
59,42
39,32
56,53
64,2
60,10
43,66
16,0
54,56
29,48
69,36
52,48
47,52
42,30
56,12
67,48
28,34
43,52
60,31
68,58
22,25
5,18
50,36
48,65
20,6
2,38
0,10
14,19
1,42
8,39
15,70
69,16
44,35
26,52
8,61
46,55
6,43
52,26
12,14
10,59
0,62
33,56
50,50
33,0
60,23
40,38
8,37
2,30
38,59
57,44
58,70
9,48
60,56
38,5
56,48
32,59
30,3
26,59
58,18
20,20
58,60
52,42
9,28
28,47
7,56
24,20
29,8
32,12
7,16
26,30
58,28
24,14
44,30
64,44
44,26
4,62
15,48
24,31
53,70
70,58
10,19
24,34
0,11
38,44
32,28
36,8
69,48
64,68
28,60
46,23
10,6
58,12
40,63
42,62
48,8
65,20
36,32
2,42
0,27
20,44
55,36
16,68
20,18
31,10
26,17
10,9
55,46
10,15
31,70
48,26
70,22
26,23
56,54
36,7
61,68
30,55
64,66
32,33
0,14'

drop table if exists AOC_2024_Day18_Map
drop table if exists AOC_2024_Day18_Edges

create table AOC_2024_Day18_Map
	(X tinyint,
	Y tinyint,
	MaxX tinyint,
	MaxY tinyint
	) as node
create unique clustered index IX_AOC_2024_Day18_Map on AOC_2024_Day18_Map($node_id)
create table AOC_2024_Day18_Edges as edge

create unique clustered index IX_AOC_2024_Day18_Edges on AOC_2024_Day18_Edges($from_id, $to_id)

drop table if exists #Maze

insert into AOC_2024_Day18_Bytes
select ordinal ID, cast(parsename(rw, 2) as int) X, cast(parsename(rw, 1) as int) Y
from string_split(replace(@Input, char(10), ''), char(13), 1) r
	cross apply (select replace([value], ',', '.') rw) i

alter index all on AOC_2024_Day18_Bytes rebuild

select c.[value] X, r.[value] Y
into #Maze
from generate_series(0, 70, 1) c
	cross join generate_series(0, 70, 1) r
	
declare @MaxID int = 1024
;with m as
	(select X, Y
		from #Maze
		except
		select X, Y
		from AOC_2024_Day18_Bytes
		where ID <= @MaxID
	)
insert into AOC_2024_Day18_Map
select X, Y, max(X) over(), max(Y) over()
from m

insert into AOC_2024_Day18_Edges
select a.$node_id, b.$node_id
from AOC_2024_Day18_Map a
	inner join AOC_2024_Day18_Map b on (b.Y = a.Y and b.X in (a.X - 1, a.X + 1))
									or (b.X = a.X and b.Y in (a.Y - 1, a.Y + 1))

;with r as
	(select i.X, i.Y, i.MaxX, i.MaxY,
			last_value(i1.X) within group (graph path) LastX,
			last_value(i1.y) within group (graph path) LastY,
			string_agg(cast(concat(i1.X, '.', i1.Y) as varchar(max)), ',') within group (graph path) Rt,
			len(string_agg(cast(isnull(nullif(i1.X, i1.X), '1') as varchar(max)), '') within group (graph path)) Steps
		from AOC_2024_Day18_Map i,
			AOC_2024_Day18_Edges for path e,
			AOC_2024_Day18_Map for path i1
		where MATCH(shortest_path(i(-(e)->i1)+))
			and i.X = 0
			and i.Y = 0
	)
select Steps Answer1
from r
where LastX = MaxX
	and LastY = MaxY

;with rec as
	(select cast((select 0 x, 0 y, concat(',', 0, '.', 0, ',') r
					from (select 1 a) t
					for json path) as varchar(max)) Rts, 0 Steps, 1 HasActiveRoutes
		union all
		select n.Rts, Steps + 1, n.HasActiveRoutes
		from rec r
			cross apply fn_AOC_2024_Day18_Step(r.Rts, 70, 70, 2500, iif(r.Steps%5 = 0, 1, 0)) n --Starting with 1024 just takes forever, so starting with 2500 byte drops to show the method
		where r.HasActiveRoutes = 1
	)
	, Final as
	(select top 1 *
		from rec
		order by Steps desc
	)
	, FirstIDs as
	(select min(b.ID) fID
		from Final
			cross apply openjson(Rts) j
			cross apply string_split(json_value([value], '$.r'), ',') r
			inner join AOC_2024_Day18_Bytes b on concat(X, '.', Y) = r.[value]
		group by j.[key]
	)
select concat(X, ',', Y) Answer2
from AOC_2024_Day18_Bytes
where ID = (select max(fID)
			from FirstIDs
			)
option (maxrecursion 32767)