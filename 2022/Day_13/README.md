Used quite a few inline table functions to make it more managable.
I'm sure there is a better way to do this one.
