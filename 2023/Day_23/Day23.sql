declare @Input varchar(max) =
'#.###########################################################################################################################################
#...#...#...#.........###.....###...#.........#.....#...###.....#.....#...#.............#.....#.......#.........#...#...###...#...###...#...#
###.#.#.#.#.#.#######.###.###.###.#.#.#######.#.###.#.#.###.###.#.###.#.#.#.###########.#.###.#.#####.#.#######.#.#.#.#.###.#.#.#.###.#.#.#.#
###...#.#.#...#...#...#...#...#...#.#.#...#...#...#.#.#...#.#...#...#.#.#.#.......#.....#...#.#.....#...#.......#.#.#.#.#...#.#.#...#.#.#.#.#
#######.#.#####.#.#.###.###.###.###.#.#.#.#.#####.#.#.###.#.#.#####.#.#.#.#######.#.#######.#.#####.#####.#######.#.#.#.#.###.#.###.#.#.#.#.#
#.......#.#.....#...###...#...#...#.#.#.#...#...#.#.#...#...#.....#.#.#.#.#.....#.#.....#...#...###.....#.###.....#.#.#.#.#...#...#.#.#...#.#
#.#######.#.#############.###.###.#.#.#.#####.#.#.#.###.#########.#.#.#.#.#.###.#.#####.#.#####.#######.#.###.#####.#.#.#.#.#####.#.#.#####.#
#.....#...#.....###...#...#...#...#.#.#.....#.#.#.#.###...#...#...#.#.#.#.#.#...#...#...#.#.....#.....#.#.#...#.....#.#...#.#...#.#...#.....#
#####.#.#######.###.#.#.###.###.###.#.#####.#.#.#.#.#####.#.#.#.###.#.#.#.#.#.#####.#.###.#.#####.###.#.#.#.###.#####.#####.#.#.#.#####.#####
#.....#.###...#...#.#.#...#.>.>.#...#.#.....#.#.#.#.#...#.#.#...#...#.#.#.#.#.#...#.#...#.#.#...#...#.#.#.#.#...#####.....#.#.#.#...#...#...#
#.#####.###.#.###v#.#.###.###v###.###.#.#####.#.#.#.#.#.#.#.#####.###.#.#.#.#.#.#.#.###.#.#.#.#.###.#.#.#.#.#.###########.#.#.#.###.#.###.#.#
#.#...#.#...#...#.>.#.#...###...#...#.#.#...#.#...#.#.#.#.#.>.>.#...#.#.#.#.#.#.#...#...#.#.#.#...#.#.#.#...#.#...###...#.#.#.#.#...#.....#.#
#.#.#.#.#.#####.#v###.#.#######.###.#.#.#.#.#.#####.#.#.#.###v#.###.#.#.#.#.#.#.#####.###.#.#.###.#.#.#.#####.#.#.###.#.#.#.#.#.#.#########.#
#...#...#.#...#.#.###.#.#.......###.#.#.#.#.#.....#...#...###.#...#.#.#.#.#.#.#.....#...#.#.#...#.#.#.#.....#.#.#.#...#...#.#.#.#.#.........#
#########.#.#.#.#.###.#.#.#########.#.#.#.#.#####.###########.###.#.#.#.#.#.#.#####.###.#.#.###.#.#.#.#####.#.#.#.#.#######.#.#.#.#.#########
#...#...#...#.#.#...#.#.#.#.......#.#.#.#.#.......#...###...#.###...#.#.#...#.#.....#...#.#.#...#.#.#...>.>.#.#.#.#.#.......#.#.#.#.........#
#.#.#.#.#####.#.###.#.#.#.#.#####.#.#.#.#.#########.#.###.#.#.#######.#.#####.#.#####.###.#.#.###.#.#####v###.#.#.#.#.#######.#.#.#########.#
#.#.#.#...#...#.....#...#...###...#...#.#...#.......#.....#...#.......#.#.....#.....#.###.#.#...#.#.#.....###...#...#.#...#...#.#...###...#.#
#.#.#.###.#.###################.#######.###.#.#################.#######.#.#########.#.###.#.###.#.#.#.###############.#.#.#.###.###.###.#.#.#
#.#.#...#.#...........###.......#...###.....#.#...#...........#.....#...#.#.....#...#.>.>.#.#...#...#.#.......#.......#.#...###.....#...#...#
#.#.###.#.###########.###.#######.#.#########.#.#.#.#########.#####.#.###.#.###.#.#####v###.#.#######.#.#####.#.#######.#############.#######
#.#.....#.........#...#...#...#...#.......#...#.#.#.#.........#####...#...#...#...###...###.#.......#...#.....#.........###...#...#...#...###
#.###############.#.###.###.#.#.#########.#.###.#.#.#.#################.#####.#######.#####.#######.#####.#################.#.#.#.#.###.#.###
#.....#.....#...#.#...#...#.#...#.........#.....#...#...#...#...#...###...#...#.....#.....#.........#...#.....#...###...#...#.#.#...###.#.###
#####.#.###.#.#.#.###.###.#.#####.#####################.#.#.#.#.#.#.#####.#.###.###.#####.###########.#.#####.#.#.###.#.#.###.#.#######.#.###
#.....#...#...#.#.....###...#.....#...#.........#...###...#.#.#...#...###...###...#.#.....#.......#...#.......#.#...#.#.#...#.#.........#...#
#.#######.#####.#############.#####.#.#.#######.#.#.#######.#.#######.###########.#.#.#####.#####.#.###########.###.#.#.###.#.#############.#
#.#...#...###...#.......###...#...#.#.#.#.......#.#.........#.....#...#...#...#...#...#...#...#...#.#.........#...#.#.#.###.#.#.....#.......#
#.#.#.#.#####.###.#####.###.###.#.#.#.#.#.#######.###############.#.###.#.#.#.#v#######.#.###.#.###.#.#######.###.#.#.#.###.#.#v###.#.#######
#...#...#...#...#.....#...#.....#...#.#.#...#...#.......#...#...#.#...#.#.#.#.>.>...###.#.#...#...#.#.#.......###.#.#.#.....#.>.###...###...#
#########.#.###v#####.###.###########.#.###.#.#.#######.#.#.#.#.#.###.#.#.#.###v###.###.#.#.#####.#.#.#.#########.#.#.#########v#########.#.#
###...#...#...#.>.#...#...#.....#.....#.#...#.#.###...#.#.#.#.#.#.#...#.#.#.#...###...#.#.#.#.....#...#...#...#...#.#.#.........#...#...#.#.#
###.#.#.#####.#v#.#.###.###.###.#.#####.#.###.#.###.#.#v#.#.#.#.#.#.###.#.#.#.#######.#.#.#.#.###########.#.#.#.###.#.#.#########.#.#.#.#.#.#
#...#.#.....#.#.#.#...#.....#...#.......#...#.#.#...#.>.>.#.#.#.#.#.#...#...#.......#.#.#...#...#...#.....#.#...###...#.#.....#...#.#.#.#.#.#
#.###.#####.#.#.#.###.#######.#############.#.#.#.#####v###.#.#.#.#.#.#############.#.#.#######.#.#.#.#####.###########.#.###.#.###.#.#.#.#.#
#...#.......#.#.#.#...###...#.....#...#.....#.#...#.....###.#.#.#.#.#.#.............#.#.#.......#.#.#.....#.....#...###.#.#...#.#...#.#.#.#.#
###.#########.#.#.#.#####.#.#####.#.#.#.#####.#####.#######.#.#.#.#.#.#.#############.#.#.#######.#.#####v#####.#.#.###.#.#.###.#.###.#.#.#.#
#...#.....###...#.#...#...#.......#.#.#...###.....#.......#...#.#.#...#...#.........#.#.#.....#...#.#...>.>...#...#...#...#...#.#...#.#.#.#.#
#.###.###.#######.###.#.###########.#.###v#######.#######.#####.#.#######.#.#######.#.#.#####.#.###.#.###v###.#######.#######.#.###.#.#.#.#.#
#...#.#...#...###.#...#...#.......#.#...>.>.......#.......#...#...#...#...#.#.......#.#...###.#...#.#.###...#...#...#.....#...#.###.#.#...#.#
###.#.#.###.#.###.#.#####.#.#####.#.#####v#########.#######.#.#####.#.#.###.#.#######.###.###.###.#.#.#####.###.#.#.#####.#.###.###.#.#####.#
###...#.....#...#.#.....#.#.....#...#.....#...#...#.........#.#...#.#.#.....#.......#.#...#...#...#.#.#...#...#.#.#.......#...#.#...#.#.....#
###############.#.#####.#.#####.#####.#####.#.#.#.###########.#.#.#.#.#############.#.#.###.###.###.#.#.#.###.#.#.###########.#.#.###.#.#####
#...#...........#.#...#.#.#...#.#.....#.....#...#...#.........#.#.#.#.#...........#.#...###...#...#.#.#.#.....#...#.........#...#.....#.....#
#.#.#.###########.#.#.#.#.#.#.#.#.#####.###########.#.#########.#.#.#.#.#########.#.#########.###.#.#.#.###########.#######.###############.#
#.#...#.........#...#.#.#.#.#.#.#.......#...#.....#.#...........#...#.#.........#.#...#...###.#...#...#...........#.......#.###...#.....#...#
#.#####.#######.#####.#.#.#.#.#.#########.#.#.###.#.#################.#########.#.###.#.#.###.#.#################.#######.#.###.#.#.###.#.###
#.......#.......#...#...#.#.#.#...#.......#...###...#.....#.........#.###.......#.....#.#...#.#.#.............#...###...#.#.###.#.#...#...###
#########.#######.#.#####.#.#.###.#.#################.###.#.#######.#.###.#############.###.#.#.#.###########.#.#####.#.#.#.###.#.###.#######
#.........#.......#.....#...#.#...#...............###...#...#.....#...#...#...#.....#...#...#...#.......#...#...###...#.#.#...#.#.###.....###
#.#########.###########.#####.#.#################.#####.#####.###.#####.###.#.#.###.#.###.#############.#.#.#######.###.#.###.#.#.#######.###
#...........#...........#...#...#...#.........#...#...#.....#.#...#...#...#.#...#...#...#.#...#...#...#...#...#...#...#...#...#.#...#####...#
#############.###########.#.#####.#.#.#######.#.###.#.#####.#.#.###.#.###.#.#####.#####.#.#.#.#.#.#.#.#######.#.#.###.#####.###.###.#######.#
#.......#.....#.....#...#.#.#.....#...#.....#.#.#...#.......#.#.#...#.###...#.....###...#.#.#.#.#.#.#.###...#...#.#...#.....###...#...#.....#
#.#####.#.#####.###.#.#.#.#.#.#########.###.#.#.#.###########.#.#.###.#######.#######.###.#.#.#.#.#.#.###.#.#####v#.###.#########.###.#.#####
#.....#...#...#...#.#.#.#.#.#...........#...#...#.......#...#.#.#...#.#...###.###...#...#.#.#...#.#.#...#.#...#.>.>.#...#...#.....#...#.....#
#####.#####.#.###.#.#.#.#.#.#############.#############v#.#.#.#.###.#.#.#.###v###.#.###.#.#.#####.#.###.#.###.#.#v###.###.#.#.#####.#######.#
#.....#...#.#.###.#.#.#.#.#.#...#.......#.#...#...###.>.>.#...#.#...#.#.#.#.>.>...#.#...#...#.....#...#.#.###.#.#.###...#.#.#.#...#...#.....#
#.#####.#v#.#.###.#.#.#.#.#.#.#.#.#####.#.#.#.#.#.###.#v#######.#.###.#.#.#.#v#####.#.#######.#######.#.#.###.#.#.#####.#.#.#.#.#.###.#.#####
#.......#.>.#.###.#.#.#.#.#.#.#.#...#...#.#.#.#.#...#.#.....###.#.###.#.#...#.....#.#.#.......#...#...#.#...#...#...#...#.#.#...#.#...#...###
#########v###.###.#.#.#.#.#.#.#.###.#.###v#.#.#.###.#.#####.###.#.###.#.#########.#.#.#.#######.#.#.###.###.#######.#.###.#.#####.#.#####.###
#.........#...#...#.#.#.#.#.#.#...#.#.#.>.>.#.#.#...#.#.....#...#...#...#.........#.#.#.#.....#.#.#.###.....#...#...#.....#...#...#.#...#...#
#.#########.###.###.#.#.#.#.#.###.#.#.#.#v###.#.#.###.#.#####.#####.#####.#########.#.#.#.###.#.#.#.#########.#.#.###########.#.###.#.#.###.#
#.........#...#...#...#.#.#...###...#...#...#.#.#.#...#...###...#...#.....#.....###.#.#.#.#...#.#...#...###...#.#...........#.#...#...#.#...#
#########.###.###.#####.#.#################.#.#.#.#.#####.#####.#.###.#####.###.###.#.#.#.#.###.#####.#.###.###.###########.#.###.#####.#.###
#.....###...#.#...###...#.......#...........#...#.#.#####.#...#...#...#...#.###...#...#...#.....#.....#...#...#...#...#.....#.#...#.....#.###
#.###.#####.#.#.#####.#########.#.###############.#.#####.#.#.#####.###.#.#.#####.###############.#######.###.###.#.#.#.#####.#.###.#####v###
#...#.....#.#.#.#.....#.....#...#.....#.........#.#.#.....#.#.....#.....#...#####...###.....#...#...#...#.#...###.#.#.#...#...#.###.....>.###
###.#####.#.#.#.#.#####.###.#.#######.#.#######.#.#.#.#####.#####.#################.###.###.#.#.###.#.#.#.#.#####.#.#.###.#.###.#########v###
###...###...#...#...#...###.#...#.....#.#.......#...#.......#...#...#...#.....#...#...#...#...#.###.#.#...#.....#.#.#.....#.#...#...#.....###
#####.#############.#.#####.###.#.#####.#.###################.#.###.#.#.#.###.#.#.###.###.#####.###.#.#########.#.#.#######.#.###.#.#.#######
#####...#...#...#...#...###.....#.......#.........#...........#.....#.#.#.#...#.#.###...#.....#.#...#.......#...#.#.......#.#.###.#.#.......#
#######.#.#.#.#.#.#####.#########################.#.#################.#.#.#.###.#.#####.#####.#.#.#########.#.###.#######.#.#.###.#.#######.#
#.......#.#.#.#.#...#...#.....#...................#...............###.#.#.#...#.#.....#.......#.#.#.......#...###.........#.#.#...#.........#
#.#######.#.#.#.###.#.###.###.#.#################################.###.#.#.###.#.#####.#########.#.#.#####.#################.#.#.#############
#.........#...#...#...###.#...#...................###...........#.#...#...#...#.....#...........#...#.....#...###.........#.#.#.#...........#
#################.#######.#.#####################.###.#########.#.#.#######.#######.#################v#####.#.###.#######.#.#.#.#.#########.#
#.........#.......###...#.#.#...#...........#.....#...#.......#...#...#.....#...###.............###.>.>.....#.#...#.......#...#...#...#.....#
#.#######.#.#########.#.#.#.#.#.#.#########.#.#####.###.#####.#######.#.#####.#.###############.###.#v#######.#.###.###############.#.#.#####
#.#...###...###...#...#.#.#.#.#.#.........#.#.....#.....#.....###...#.#.....#.#.#...............#...#.#.......#...#...#...#...###...#...#...#
#.#.#.#########.#.#.###.#.#.#.#.#########.#.#####.#######.#######.#.#.#####.#.#.#.###############.###.#.#########.###.#.#.#.#.###.#######.#.#
#...#.#...#...#.#.#...#.#.#.#.#.#...#...#.#.......#...###.......#.#...#.....#.#.#...........#...#.###.#...###...#.#...#.#...#...#.........#.#
#####v#.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#.#v#########.#.#########.#.#####.#####.#.###########.#.#.#.###.###.###.#.#.#.###.#######.###########.#
#...#.>.#.#.#.#.#.#...#.#.#.#.#.#.#.#.#.>.>.....#...#.#.........#...#...#...#.#.#...#...#...#.#.#...#...#...#.#.#.#.###.#.......#...###...#.#
#.#.#v###.#.#.#.#.#.###.#.#.#.#.#.#.#.###v#####.#.###.#.###########.#.###.#.#.#.#.#.#.#.#v###.#.###.###.###.#.#.#.#.###.#.#######.#.###.#.#.#
#.#.#...#.#.#.#.#.#.###.#.#.#.#...#...###.#.....#...#.#...#.........#...#.#.#.#.#.#.#.#.>.>.#.#...#...#...#...#.#.#.....#...#...#.#.#...#.#.#
#.#.###.#.#.#.#.#.#.###.#.#.#.###########.#.#######.#.###v#.###########.#.#.#.#.#.#.#.###v#.#.###.###.###.#####.#.#########.#.#.#.#.#.###.#.#
#.#.#...#.#.#.#.#...###.#.#.#.###...#...#.#...#...#.#.#.>.>.#...###.....#.#.#.#...#...###.#.#.###.#...#...#...#.#.#.........#.#.#.#.#...#.#.#
#.#.#.###.#.#.#.#######.#.#.#.###.#.#.#.#.###.#.#.#.#.#.#v###.#.###.#####.#.#.###########.#.#.###.#.###.###.#.#.#.#.#########.#.#.#.###v#.#.#
#.#...###...#.#.....#...#.#.#.#...#...#.#.###.#.#.#.#...#.#...#...#.#...#.#.#...#.........#...###...###.....#.#...#.......#...#...#...>.#...#
#.###########.#####.#.###.#.#.#.#######.#.###.#.#.#.#####.#.#####.#.#.#.#.#.###.#.###########################.###########.#.###########v#####
#.#...###...#.......#...#.#...#...#...#...#...#.#.#.###...#.#.....#...#...#.#...#...#...........###...........#...#...###.#.#.......#...#...#
#.#.#.###.#.###########.#.#######.#.#.#####.###.#.#.###.###.#.#############.#.#####.#.#########.###.###########.#.#.#.###.#.#.#####.#.###.#.#
#...#...#.#...........#.#.###...#...#.....#.#...#.#...#...#.#...#...###...#...#...#.#.#.........#...#...#...#...#...#...#...#.....#.#.....#.#
#######.#.###########.#.#.###.#.#########.#.#.###.###.###.#.###.#.#.###.#.#####.#.#.#.#.#########.###.#.#.#.#.#########.#########.#.#######.#
###.....#.#.........#.#...#...#...#.......#...###.....###.#.###...#.....#...#...#.#...#...#.....#.#...#.#.#.#.#.........#.........#.#...#...#
###.#####.#.#######.#.#####.#####.#.#####################.#.###############.#.###.#######.#.###.#.#.###.#.#.#.#.#########.#########.#.#.#.###
#...#.....#.....###...#...#.....#.#...#...#...###...###...#.#...............#.#...#...###...#...#.#...#...#...#.........#...#.....#...#...###
#.###.#########.#######.#.#####.#.###.#.#.#.#.###.#.###.###.#.###############.#.###.#.#######.###.###.#################.###.#.###.###########
#.....#.........#...#...#.#.....#...#...#...#...#.#...#.#...#.........#.......#.#...#.#...#...###.....#.................###.#.###...........#
#######.#########.#.#.###.#.#######.###########.#.###.#.#.###########.#.#######.#.###.#.#.#.###########.###################.#.#############.#
#.......#...#...#.#.#...#.#.....#...#...........#.#...#...#...#.....#.#.....#...#...#...#...###.......#.................###...#.....#.......#
#.#######.#.#.#.#.#.###.#.#####.#.###v###########.#.#######.#.#.###.#.#####.#.#####v###########.#####.#################.#######.###.#.#######
#.#...#...#.#.#.#.#...#.#.#...#.#.#.>.>...#.....#.#.....#...#...###...#...#.#.#...>.>.......#...#.....#...###...#.......#...###...#.#.......#
#.#.#.#.###v#.#.#.###.#.#.#.#.#.#.#.#v###.#.###.#.#####.#.#############.#.#.#.#.###v#######.#.###.#####.#.###.#.#.#######.#.#####.#.#######.#
#.#.#...###.>.#.#...#.#.#.#.#.#.#...#.#...#.#...#...#...#.......#...###.#...#.#...#.#.......#...#...#...#.#...#.#.......#.#.#...#.#.....#...#
#.#.#######v###.###.#.#.#.#.#.#.#####.#.###.#.#####.#.#########.#.#.###.#####.###.#.#.#########.###.#.###.#.###.#######.#.#.#.#.#.#####.#.###
#...###...#...#.....#.#.#.#.#.#...#...#...#.#.#...#.#.#...#...#.#.#...#.....#.#...#.#...###...#.#...#...#.#...#.#.......#.#.#.#.#.#...#...###
#######.#.###.#######.#.#.#.#.###.#.#####.#.#.#.#.#.#.#.#.#.#.#v#.###.#####.#.#.###.###.###.#.#.#.#####.#.###.#.#v#######.#.#.#.#.#.#.#######
#.......#...#.......#.#.#...#...#.#...###...#.#.#.#.#...#...#.>.>.###.#.....#.#.#...###...#.#.#.#...#...#.....#.>.>.#...#.#.#.#.#.#.#.#...###
#.#########.#######.#.#.#######.#.###.#######.#.#.#.###########v#####.#.#####.#.#.#######.#.#.#.###.#.###########v#.#.#.#.#.#.#.#v#.#.#.#.###
#.........#.........#...###...#...###.......#.#.#.#.#...#...###.....#.#...###...#.......#.#.#.#.###.#...#.......#.#...#.#.#.#.#.>.#.#...#...#
#########.#################.#.#############.#.#.#.#.#.#.#.#.#######.#.###.#############.#.#.#.#.###.###.#.#####.#.#####.#.#.#.###v#.#######.#
#.........#...#...#...#.....#...#...........#.#.#.#.#.#...#...#.....#.#...#...###.....#.#.#.#.#.#...#...#...###.#.#.....#.#...#...#.#.......#
#.#########.#.#.#.#.#.#.#######.#.###########.#.#.#.#.#######.#.#####.#.###.#.###.###.#.#.#.#.#.#.###.#####.###.#.#.#####.#####.###.#.#######
#.........#.#...#...#...#.....#.#...........#.#.#...#.......#.#.....#...###.#.#...#...#.#.#.#...#.....#...#...#.#.#.#...#.....#.....#.......#
#########.#.#############.###.#.###########.#.#.###########.#.#####.#######.#.#.###.###.#.#.###########.#.###.#.#.#.#.#.#####.#############.#
#####...#...#...#.........###...#...........#...#...........#...#...#.......#...###.....#.#.....#.......#.....#.#.#.#.#.#...#.#.............#
#####.#.#####.#.#.###############.###############.#############.#.###.###################.#####.#.#############.#.#.#.#.#.#.#.#.#############
###...#...###.#.#.........#...###...........#...#.............#...###...#...#...#.......#.#.....#...........###...#...#...#...#.............#
###.#####.###.#.#########.#.#.#############.#.#.#############.#########.#.#.#.#.#.#####.#.#.###############.###############################.#
#...#...#.....#...........#.#.###.........#...#...#...........###...###...#...#...#.....#...#...#.......###...#...###...#...###.............#
#.###.#.###################.#.###.#######.#######.#.#############.#.###############.#########.#.#.#####.#####.#.#.###.#.#.#.###.#############
#...#.#...#...#.......#.....#...#...#...#...#.....#.............#.#.#.....#.........#...###...#.#.....#.......#.#...#.#.#.#...#.............#
###.#.###.#.#.#.#####.#.#######.###.#.#.###.#.#################.#.#.#.###.#.#########.#.###.###.#####.#########.###.#.#.#.###.#############.#
###...###...#.#.#.....#...#.....###...#...#.#.#.............#...#.#.#...#.#.....#...#.#.#...#...#...#.......#...#...#.#.#...#.#...#...#.....#
#############.#.#.#######.#.#############.#.#.#.###########.#.###.#.###.#.#####.#.#.#.#.#.###.###.#.#######.#.###.###.#.###.#.#.#.#v#.#.#####
#.............#.#.#...###.#.#...#...###...#...#...........#...#...#...#.#.......#.#...#.#.#...#...#.........#...#...#.#...#.#.#.#.>.#.#.#...#
#.#############.#.#.#.###.#.#.#.#.#.###v#################.#####.#####.#.#########.#####.#.#.###.###############.###.#.###.#.#.#.###v#.#.#.#.#
#.#...#...#...#.#...#...#.#...#.#.#...>.>...###...#.......###...#.....#...#.......#.....#.#.###.............#...#...#...#.#.#...#...#...#.#.#
#.#.#.#.#.#.#.#.#######.#.#####.#.#########.###.#.#.#########.###.#######.#.#######.#####.#.###############.#.###.#####.#.#.#####.#######.#.#
#...#...#.#.#.#.#.......#.#.....#...#.......#...#.#.......#...#...#...###...###.....#.....#.#...###.....#...#...#...#...#.#...###.....###.#.#
#########.#.#.#.#.#######.#.#######.#.#######.###.#######.#.###.###.#.#########.#####.#####.#.#.###.###.#.#####.###.#.###.###.#######.###.#.#
#...#.....#.#...#.........#.#.......#.....###.#...#...#...#.#...#...#.....#.....#...#.....#.#.#.###.#...#...###...#.#.###...#.#.......#...#.#
#.#.#.#####.###############.#.###########.###.#.###.#.#v###.#.###.#######.#.#####.#.#####.#.#.#.###.#.#####v#####.#.#.#####.#.#.#######.###.#
#.#...#...#.#...............#.........#...#...#...#.#.>.>.#.#.###...#.....#.....#.#.....#.#.#.#.#...#...#.>.>.#...#...#.....#.#.......#.###.#
#.#####.#.#.#.#######################.#.###.#####.#.#####.#.#.#####.#.#########v#.#####.#.#.#.#.#.#####.#.###.#.#######.#####.#######.#.###.#
#...#...#.#.#.#...#.....#...#...#...#.#.#...#.....#.#.....#.#...#...#...#...#.>.>.#.....#.#.#.#.#.#.....#.#...#.......#...#...#.......#.#...#
###.#.###.#.#.#.#.#.###.#.#.#.#.#.#.#.#.#.###.#####.#.#####.###.#.#####.#.#.#.#####.#####.#.#.#.#.#.#####.#.#########.###.#.###.#######.#.###
###...###...#...#...###...#...#...#...#...###.......#.......###...#####...#...#####.......#...#...#.......#...........###...###.........#...#
###########################################################################################################################################.#'
use tempdb
drop table if exists AOC_2023_Day23_Map
drop table if exists AOC_2023_Day23_Edges
drop table if exists #temp
drop table if exists #Input
drop table if exists #Routes
drop table if exists #Best
drop table if exists #Best1
drop table if exists #Relationships
drop table if exists #Relationships1

create table AOC_2023_Day23_Map
	(id int,
	x int,
	y int,
	MaxY int,
	w int,
	e int,
	n int,
	s int,
	neighbors int
	) as node

create table AOC_2023_Day23_Edges(steps int) as edge
create unique clustered index IX_AOC_2023_Day23_Edges on AOC_2023_Day23_Edges($from_id, $to_id)

;with i as
	(select c.[value] x, r.ordinal y, substring(r.[value], c.[value], 1) symbol
		from string_split(replace(@Input, char(10), ''), char(13), 1) r
			cross apply generate_series(cast(1 as int), cast(len(r.[value]) as int), cast(1 as int)) c
	)
	, i1 as
	(select *
			, max(y) over() MaxY
			, lag(x, 1, 0) over(partition by y order by x) w
			, lead(x, 1, 0) over(partition by y order by x) e
			, lag(y, 1, 0) over(partition by x order by y) n
			, lead(y, 1, 0) over(partition by x order by y) s
			, lag(symbol, 1, '') over(partition by y order by x) w_s
			, lead(symbol, 1, '') over(partition by y order by x) e_s
			, lag(symbol, 1, '') over(partition by x order by y) n_s
			, lead(symbol, 1, '') over(partition by x order by y) s_s
		from i
		where symbol != '#'
	)
select x, y, symbol, MaxY
	, iif(w = x - 1, w, 0) w
	, iif(e = x + 1, e, 0) e
	, iif(n = y - 1, n, 0) n
	, iif(s = y + 1, s, 0) s
into #temp
from i1
	
select x, y, MaxY
	, iif(w > 0 and not exists (select * from #temp t1 where t1.y = t.y and t1.x between t.w and t.x and t1.symbol = '>'), lag(x, 1, 0) over(partition by y order by x), 0) w
	, iif(e > 0 and not exists (select * from #temp t1 where t1.y = t.y and t1.x between t.x and t.e and t1.symbol = '<'), lead(x, 1, 0) over(partition by y order by x), 0) e
	, iif(n > 0 and not exists (select * from #temp t1 where t1.x = t.x and t1.y between t.n and t.y and t1.symbol = 'v'), lag(y, 1, 0) over(partition by x order by y), 0) n
	, iif(s > 0 and not exists (select * from #temp t1 where t1.x = t.x and t1.y between t.x and t.s and t1.symbol = '^'), lead(y, 1, 0) over(partition by x order by y), 0) s
into #Input
from #temp t
	cross apply (select iif(w + e > 0 and n + s > 0, 1, 0) IsTurn) n
where IsTurn = 1
	or y = 1
	or y = MaxY

--1
;with rec as
	(select x, y, cast(0 as int) steps, 0 lvl, cast(concat(',', co, ',') as varchar(max)) pth, MaxY
		from #Input
			cross apply (select concat(x, ' ', y) co) c
		where y = 1
		union all
		select n.x, n.y, cast(r.steps + abs(n.x - r.x) + abs(n.y - r.y) as int) steps, r.lvl + 1 lvl, cast(concat(r.pth, co, ',') as varchar(max)) pth, r.MaxY
		from rec r
			inner join #Input i on i.x = r.x
								and i.y = r.y
			cross apply (values(w, r.y)
							, (e, r.y)
							, (r.x, n)
							, (r.x, s)
						) n(x, y)
			cross apply (select concat(n.x, ' ', n.y) co) c
		where n.x > 0
			and n.y > 0
			and pth not like concat('%,', co, ',%')
			and r.y < r.MaxY
	)
select top 1 steps Answer1
from rec
where y = MaxY
order by Answer1 desc
option (maxrecursion 32767)

--2
insert into AOC_2023_Day23_Map
select row_number() over(order by y, x) id, x, y, MaxY
	, iif(w > 0, lag(x, 1, 0) over(partition by y order by x), 0) w
	, iif(e > 0, lead(x, 1, 0) over(partition by y order by x), 0) e
	, iif(n > 0, lag(y, 1, 0) over(partition by x order by y), 0) n
	, iif(s > 0, lead(y, 1, 0) over(partition by x order by y), 0) s
	, (select count(*)
		from (values(w)
				, (e)
				, (n)
				, (s)
			) d(dir)
		where dir > 0
	)
from #temp t
	cross apply (select iif(w + e > 0 and n + s > 0, 1, 0) IsTurn) n
where IsTurn = 1
	or y = 1
	or y = MaxY

insert into AOC_2023_Day23_Edges
select i.$node_id, i1.$node_id, abs(i.x - i1.x) + abs(i.y - i1.y) steps
from AOC_2023_Day23_Map i
	inner join AOC_2023_Day23_Map i1 on ((i1.y = i.y and i1.x in (i.w, i.e))
								or (i1.x = i.x and i1.y in (i.n, i.s))
							) 
where i.neighbors = 2
	and i1.neighbors = 2

alter index all on AOC_2023_Day23_Edges rebuild

select i.id id1,
	',' + string_agg(cast(i1.id as varchar(max)), ',') within group (graph path) + ',' Rt,
	sum(e.steps) within group (graph path) steps,
	count(i1.$node_id) within group (graph path) turns,
	last_value(i1.id) within group (graph path) id2
into #Routes
from AOC_2023_Day23_Map i,
	AOC_2023_Day23_Edges for path e,
	AOC_2023_Day23_Map for path i1
where match(shortest_path(i(-(e)->i1)+))

select id, id1, id2, steps
into #Best
from AOC_2023_Day23_Map
	cross apply (select top 1 with ties id1, Rt, steps, turns, id2
					from #Routes
					where Rt like concat('%,', id, ',%')
					order by turns desc
				) t

select id1, id2, steps
into #Best1
from #Best
where id in (select distinct id1
				from #Best
			)

;with i as
	(select row_number() over(order by y, x) id, x, y, MaxY
			, iif(w > 0, lag(x, 1, 0) over(partition by y order by x), 0) w
			, iif(e > 0, lead(x, 1, 0) over(partition by y order by x), 0) e
			, iif(n > 0, lag(y, 1, 0) over(partition by x order by y), 0) n
			, iif(s > 0, lead(y, 1, 0) over(partition by x order by y), 0) s
		from #temp t
			cross apply (select iif(w + e > 0 and n + s > 0, 1, 0) IsTurn) n
		where IsTurn = 1
			or y = 1
			or y = MaxY
	)
select i.id id1, i1.id id2, abs(i.x - i1.x) + abs(i.y - i1.y) steps, iif(i.y = 1, 1, 0) strt, iif(i.y = i.MaxY, 1, 0) en, count(*) over(partition by i.id) Neighbors
into #Relationships
from i
	inner join i i1 on ((i1.y = i.y and i1.x in (i.w, i.e))
								or (i1.x = i.x and i1.y in (i.n, i.s))
							)

select distinct s.id1, d.id2, s.steps + d.steps + i.steps steps, s.strt, s.en
into #Relationships1
from #Best1 i
	inner join #Relationships s on s.id2 = i.id1
	inner join #Relationships d on d.id1 = i.id2
where s.Neighbors != 2
	and not exists (select *
					from #Relationships d2
					where d2.id1 = d.id2
						and d2.Neighbors = 2
					)

;with rec as
	(select id1, id2, cast(0 as int) total_steps, steps, en, 0 turns, cast(concat(',', id1, ',') as varchar(max)) pth
		from #Relationships1
		where strt = 1
		union all
		select n.id1, n.id2, cast(r.total_steps + r.steps as int) total_steps, n.steps, n.en, r.turns + 1 turns, cast(concat(pth, n.id1, ',') as varchar(max)) pth
		from rec r
			inner join #Relationships1 n on n.id1 = r.id2
		where r.en = 0
			and (pth not like concat('%,', n.id2, ',%')
				or n.en = 1
				)
			--and r.turns < 1
					
	)
select max(steps) Answer2
from rec
where en = 1
option (maxrecursion 32767)