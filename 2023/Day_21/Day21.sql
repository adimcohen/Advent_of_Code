declare @Input varchar(max) =
'...................................................................................................................................
................#..#.....#...#........................#...............#................#..........#.......#.....#......#.....#.....
..#..........#...#......#..#.........##.....#....#.....................................#.......#.#........#...#...#.....#..........
....#......##.......#..................#...#......#.............................#..#....#..........#...............................
..................................#...........#...##......................#.#.......##....................#.................#......
..##.#..#.........#.............#.#.....#..................................#................#.......................#..#........#..
...........#.#....#.....#...#..................................#............#......#..#.........#..#....#.......................#..
........#..............#.....#......#...#...........................#...................#.#....#..#........#...#...................
...#......#.....##.............................#.#.......................................................#....#..#..#..............
..#..#...#.....#..#....................#.#...#................#.......................#........#.......#..#........................
...#.#.........#...............#.#.....#.........##..........###.....#.........#.........................#......#..#...#...........
.................#.......##...#........#..................#......................#........#..#.......#............#.#....#.........
.....##........#.............#...#.............................#........##......................#....#..................#.....#....
...................#...#...#......#.#.#...................#.....#.........#..........................#..........#..#.#......#..#.#.
...#.##..#..............................#............................#.................#.......#...#.......#........#...........#..
...#................#....#........................................#.....#............................#..#....#....#.........#......
....#.#.....#............#....#...#.........................#.#...#....#.....#...................#.....##....#.......#...........#.
.#..................##..#.#...............#...............#.#..#...#..#...#.#...........#.#................................#...###.
...............#..........#.....#..#.....#.........##..........##.....#.......##..........#...#..............................#.....
.#..#..##.#.........................##.....................#.................##...............#.#......#.......#......#............
.........##..#.#...............##....................#...#............#.....................##......##....#..........#........#....
.............#...#....#.#..........#.....................#...##.....#.........#...........#.#.............#.#.............##.......
.#.#....#....................#..#.......................#....##.........#......#.........................................#.........
.........#......#..##..#..............................#.......#.....#..............#.................#......#..##...........#......
.#...#..........#..........#....##..................................#.#.......#.................#.#.........#.........#......#.....
..........#....#.....#...................................#............#.....#.........#..................#......#..#....#.....#....
.........#.....................##...........#.#.........#.#......................#.....#........#...#...........##.................
..#....#.........#.............#...........#............#.#....##..........#...#.#..........................#.#....................
....#...........#......###....................#....#.....#..#.....#..#.....#......................##...#.....#..#.....#....#.......
...........#....#...#...#.........................#.......#..#...........#.....#..#.................#..........................#...
........#.......#.#.#..#...............#.#.............................#...#..............#...........##..............#.#..........
..................................................#...........#.....#............#.....................#.....#....###..........#...
.#.#.......#.....#...................#...................#.#..................#....#..........................#....................
..........#....#......#...................#...#............................................................#............#.#..#.#...
..................#..#.....#..........#.#.........................#.....................#.............................#...#........
.........#................#............###.....................#.....#...........#...#....#...............#.........#...........#..
.....#.#.............#..............#....##.....###..##........#..............#............#.......................................
..............#...#..#..........#....#........#........#.......#...............#........#...#.#...#.........#......#......#..#.....
........#........#...............#...#..#...#......##..........#..................#...............#.........#.....#.......#....##..
.........#...##................#.........#...#...........#.....#...#......#....#.#............................#....................
...................................#.............#.......................................#..........##.........#...#.##...#....#...
.............#.............................##.............#.................................##...#....#.................#.....#.#..
.........#......#..............#......#........#..........#..##......#.................#.......................#.......#..#....#...
.....#.#......#...........#...........#....................#.#.....#................#.........#......#.............................
...............#........................................#....#.....#.....#.........#..........#...#....#...........................
.#.............................####.........##.#.#....#.#.......#...##....#............#.#...#.....................#..#............
......#..........................#.....#............................#.#....##......#........#...........#..........................
.......#.#..#.#.........#................#........#.....#.......#....#.......#.#......................###................#.........
.#........##..........#......#......#.......#...#...#.......#.....#................#.......#..#......#.......#.................#...
..............................................#...#.......................#.....#..............##..#..#.....#......................
...................#......#....................#.........#....#....#..#.#.........##....#........#.................................
.....................#..#..........##..............#.....#.#........#................#......................................#......
..#...............#...........#................#.......#...............#..#...#.....#.............#..##....#...............#..#....
...#.#..#........#.#...........##.............#...#......##..#.....#......#.....#..#.......#.......#...#.##...##..........#........
..#..................##....................#.......................................#.....#......#.....###.....#.............#......
..#............#...........#.......#.#................##.....#.##...............#.#..#.................#..#........#...............
..............#..................#........#.........#.......#................#........#........#.....#.#...........#...............
..................#............#.....#...#.#...#...#......#.....#.....#....#..........#........................................#...
.#.........#........#........#.............#...#..#...#...................#......#.................#...#.#.........................
..............#..........##..#....#.....#.......#....#..#..............#..#..............#.................#....#..................
..........#...#...##........#......#.......###...##..........#...........................#...............#.##.........#............
................##..#.............#......#...##......#.....#..............................#.......##.........#..#....#...##........
.................#.......#.......#..#...##...#.......#.....#............#.................##........#.......#.##..........#........
........#....................##.......#.....#..............#.............#.......#...#...........###.............#..#......#.......
..............##............#.#..........##..............#.....#.....#..##.............##..............#.#.........................
.................................................................S.................................................................
..........#.........#.......##...#.#.......#.#.......#...#........##........##...............#..#..#.#..#............##.##.........
........#...............##.........#.........#.#........#.#.#............##....#.......#...#.##...#...#...#........#.....##........
..........#.........................#...#....#.............##..........#..............#.##.........#............#..................
...........#.#................##..........................#..#...............###..#.............#...#..#.........##................
...................................##.............#....#..#.#......#...##.....#..........#.#..........#...........#..............#.
........................#......##.....................#..#...........#............#.........#...................#....#.#...........
...............#....................................#....................................#......#...............#......#...........
..#.............................###...........#........#..#....#....#..#....#..........#....#...#..................................
.................#........................#.......#.#..#.....................#..........##..#....#.#........#.#....................
.....................#...............................................#..#.........#..#.......#.................#...................
.......#........#..#.............#..#......###...#....#................#.....##....#.#..............#.............#.........#.#..#.
.#...#...........#.#..#....#.....#....##..............#...#...........#.....................#.....#..........#.....................
.........#............#.....#.........#.....#...#..#..#.....................#..#..............##..............#....................
.#..#..#....................#..##...#.........#............................#........#.....#.............#.#.............#.#...#....
..#.#.....##..........#.##............#......#..#..............#....#..............#......#..#..#.......#...............#..........
.....................#..........#...##.............#.............................#.....#.....#............#.#..............#.......
..........##............#............#..#..#.........#.#............#..#.................#.......#.....#......................#....
.....#..................#.....#........##.................#.....#....#...#................#....#......#.....#............#....#....
.....#..#.....#..........#...#..#....#....#........#..#..#.....#....#..#..........#............#...##.#...#..............#.......#.
....#...#......#..........#.......#....#........#..#..#.......#.#.................##...#...#.#.#.........#......................#..
..................................#.....#..##...#............#..#..#..........#....#...............#.....................#..#...#..
..#.......#...#.................#...#..............##..................#............#......#........................#........#.....
..#.......#.................#.......#................#..#.#.#......#..................#........#...#........................#..##..
...........#.............................#....###..................#......#.....#.........#...#................#.......#...#.#.....
....#...#.......#................##....#.#..#..#...#..................##....#.................#................##............##....
....................#...............##............##..........#.......#........#........#.......................##..........#......
...#.....#.......#.................#........#.....................#..##........#......................................#......#..#..
.#.....................................##.................#.#.....#......##.#..##................................#...........#.....
................#........#............#...................#........##...................................................#.##.......
.........................#.............#.#..##..#......#.#........#...............#....##...................#.....#................
.....#...#........#.#....................#.#...#..#...#......#......#...................###................#.....#.#...#.......#...
.....#.....................#............#....#.#..#.##...............##.........#........................#.........#....#..........
............#..............#.#.......#...........#....................#......................#.......................#...#.........
..#....###.....##............##................###.#....................#.....#....#..................#..##..#.#...#.........#.....
......##.......#.................................#..#..#.....#..#.#.#.#....#..##.....#.....#.......................#.....#.#..###..
.#.......................#...................#.##..............#...............#..................#.#........#...........#..#......
........#........#..........................#...#..##.................#..#..#.##.......#..............#.#.........#....##..........
.....#...#............##..#......##..............##.###....................#............#.......#............................#.....
........#.#.........##...#.#.....#............#.............#............#......#...............#.#..........................#..##.
...#..#.#...............#....#..##..............#............#.........##...........#.........#...........#...#....#...........#...
.##.......#..##......................................##................#.....#.....................................................
...##.......#......#...#............................................#...#.........................#.#.......#.#.......#....##..#...
..#........#...#.#.#.#.............#...#...............#...............#...................#....#....#...#.#.....#............#....
........................#........#......#.........#......#..........................................#....#.......#..........#......
........#...........#....#..........#.................#......#..#...#.......#...#.....................................#........#...
...#.#..#.#.#....##...#........#......................#....##......#......#...................................#...#.........#......
..#.............#.......#..............#................#....#........#.....##................#.#....#...#.#....#......#..#........
........#...................#...#...........................#.........................#.....#........#......................#.#..#.
.............#....##.....#.#........#......................#..#....#.....#...............#.....#......#.....#....#..#..........#...
..#....#.....#.#.#...........#.#..........#.................#..#...#..................#..........................#.#.....#..#......
...#.....................#.......#...#...#............................##...................#.....#...#.................#...........
..#.....#.............#......##..............##...................#......#.........................##.......#..........#...........
...#................#....#.##.........................................###...........#.#.....#..#...............#...##..............
.......#............#........#...............##..#........................................#.#...........#.....#...#..#.......#.....
......#...................#...##.............................#....#....#........#........#....#........##..........#.........#...#.
..#.#.#......##..#.#.##...........#.#........#....................#.............................................##...#.#.##........
......#.................##..#.#......#.............##..................................#.............#....##..........#............
.......#.#...#...........#.........................#...........#................#............##....#.........#.................#...
....#....##.........#.........#..........##.....##..............#.......................#.....#.#.#.......#...#...#.............#..
...#....#....#.............#...............#....#....###...................#........#.............#.....#..#.........#.....#....#..
....#..............................#..#..........#.................................#.#.................................#..#.....#..
.......###...........................#.................#.#.........................................#.....#...#.........##..........
...........#....#..........#..#..............##..........#...................#.#............#.......#.#..#.#....#.........#......#.
.....#..........###..#.....#.#.........#.............####..#.............#..#.......#.............#...#..........#......#.#........
...................................................................................................................................'

use tempdb
drop table if exists AOC_2023_Day21_Map
drop table if exists AOC_2023_Day21_Edges
drop table if exists AOC_2023_Day21_Map1
drop table if exists AOC_2023_Day21_Edges1

drop table if exists #Route
drop table if exists #Route1
drop table if exists #StepCount

create table AOC_2023_Day21_Map
	(X tinyint,
	Y tinyint,
	Symbol char(1),
	MaxX int
	) as node
create unique clustered index IX_AOC_2023_Day21_Map1a on AOC_2023_Day21_Map(X, Y) with (data_compression=page)
create unique index IX_AOC_2023_Day21_Map1b on AOC_2023_Day21_Map(Y, X) include(Symbol, $node_id) with (data_compression=page)

create table AOC_2023_Day21_Map1
	(X int,
	Y int,
	Symbol char(1)
	) as node
create unique clustered index IX_AOC_2023_Day21_Map1a on AOC_2023_Day21_Map1(X, Y)
create unique index IX_AOC_2023_Day21_Map1b on AOC_2023_Day21_Map1(Y, X) include(Symbol, $node_id)

create table AOC_2023_Day21_Edges as edge
create unique clustered index IX_AOC_2023_Day21_Edges on AOC_2023_Day21_Edges($from_id, $to_id)

create table AOC_2023_Day21_Edges1 as edge
create unique clustered index IX_AOC_2023_Day21_Edges on AOC_2023_Day21_Edges1($from_id, $to_id)

--1
insert into AOC_2023_Day21_Map
select c.[value] X, r.ordinal Y, substring(r.[value], c.[value], 1) Symbol, max(c.[value]) over()
from string_split(replace(@Input, char(10), ''), char(13), 1) r
	cross apply generate_series(cast(1 as int), cast(len(r.[value]) as int), cast(1 as int)) c
where substring(r.[value], c.[value], 1) != '#'

alter index all on AOC_2023_Day21_Map rebuild

insert into AOC_2023_Day21_Edges
select a.$node_id, b.$node_id
from AOC_2023_Day21_Map a
	inner join AOC_2023_Day21_Map b on (b.Y = a.Y
										and b.X in (a.X - 1, a.X + 1)
										)
									or (b.X = a.X
										and b.Y in (a.Y - 1, a.Y + 1)
										)

alter index all on AOC_2023_Day21_Edges rebuild

;with i as
	(select string_agg(cast(concat(i1.X, '.', i1.Y) as varchar(max)), ',') within group (graph path) Rt,
			count(i1.$node_id) within group (graph path) Steps
		from AOC_2023_Day21_Map i,
			AOC_2023_Day21_Edges for path e,
			AOC_2023_Day21_Map for path i1
		where MATCH(shortest_path(i(-(e)->i1)+))
			and i.Symbol = 'S'
	)
select *
into #Route
from i
where Steps <= 64

select count(distinct [value]) Answer1
from #Route
	cross apply string_split(Rt, ',', 1)
where ordinal%2 = 0

--2 --Takes ~2 hours to run
insert into AOC_2023_Day21_Map1
select X, Y, Symbol
from AOC_2023_Day21_Map
union
select (X + AddX*m.ValX*m1.ValX) X, (Y + AddY*m.ValY*m1.ValY) Y, replace(Symbol, 'S', '.')
from AOC_2023_Day21_Map
	cross apply (values(0, MaxX)
					, (MaxX, 0)
					, (MaxX, MaxX)
				) s(AddX, AddY)
	cross join (values(1, 1)
					,(1, -1)
					,(-1, -1)
					,(-1, 1)
				) m(ValX, ValY)
	cross join (values(1, 1)
					, (1, 2)
					, (2, 1)
					, (2, 2)
				) m1(ValX, ValY)

alter index all on AOC_2023_Day21_Map1 rebuild

insert into AOC_2023_Day21_Edges1
select a.$node_id, b.$node_id
from AOC_2023_Day21_Map1 a
	inner join AOC_2023_Day21_Map1 b with (forceseek) on (b.Y = a.Y
										and b.X in (a.X - 1, a.X + 1)
										)
									or (b.X = a.X
										and b.Y in (a.Y - 1, a.Y + 1)
										)

alter index all on AOC_2023_Day21_Edges1 rebuild

;with i as
	(select string_agg(cast(concat(i1.X, '.', i1.Y) as varchar(max)), ',') within group (graph path) Rt,
			count(i1.$node_id) within group (graph path) Steps
		from AOC_2023_Day21_Map1 i,
			AOC_2023_Day21_Edges1 for path e,
			AOC_2023_Day21_Map1 for path i1
		where MATCH(shortest_path(i(-(e)->i1)+))
			and i.Symbol = 'S'
	)
select *
into #Route1
from i
where Steps <= (select top 1 MaxX from AOC_2023_Day21_Map)*2.5

select count(distinct iif(Steps <= x0 and ordinal%2 = x0%2, [value], null)) y0
	, count(distinct iif(Steps <= x1 and ordinal%2 = x1%2, [value], null)) y1
	, count(distinct iif(Steps <= x2 and ordinal%2 = x2%2, [value], null)) y2
into #StepCount
from #Route1
	cross apply (select top 1 cast(MaxX/2 as bigint) x0, cast(MaxX*1.5 as bigint) x1, cast(MaxX*2.5 as bigint) x2, cast(26501365 as bigint) x
					from AOC_2023_Day21_Map
				) mx
	cross apply string_split(Rt, ',', 1)

--2
select cast(a*power(x, 2) + b*x + c as bigint) Answer2
from #StepCount
	cross apply (select top 1 cast(MaxX/2 as bigint) x0, cast(MaxX*1.5 as bigint) x1, cast(MaxX*2.5 as bigint) x2, cast((26501365 - MaxX/2)/MaxX as bigint) x
					from AOC_2023_Day21_Map
				) mx
	cross apply (select y0/2. - y1 + y2/2. a, -3*y0/2. + 2*y1 - y2/2. b, y0 c, y2/2. k) abc